script:
  - scene: final_intro
  - scene: sleeping_kogoro
  - scene: readiness_gate
  - scene: ready_line
  - scene: not_ready_line
  - scene: trick_choice
  - scene: trick_correct
  - scene: trick_wrong
  - scene: time_input
  - scene: time_correct
  - scene: time_wrong
  - scene: culprit_choice
  - scene: culprit_correct
  - scene: culprit_wrong
  - scene: motive_choice
  - scene: motive_correct
  - scene: motive_wrong
  - scene: verdict_branch
  - scene: true_epilogue
  - scene: normal_epilogue
  - scene: bad_epilogue

scenes:
  final_intro:
    actions:
      - bg: case_board
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "<speed=48>전원 집합.</speed> <speed=34>밀실 중독 사건의 마지막 검증을 시작한다.</speed>"
      - say:
          char: 코난.think
          text: "<speed=26>(여기서 틀리면 끝이다.)</speed> <speed=58>증거를 한 줄도 빼지 않는다.</speed>"
      - goto: sleeping_kogoro

  sleeping_kogoro:
    actions:
      - bg: ryokan_hall
      - char:
          id: 코고로
          position: left
          emotion: proud
      - char:
          id: 코난
          position: center
          emotion: think
      - effect: flash
      - sound: door
      - say:
          char: 코난.think
          with:
            - 코고로.proud
          text: "<speed=24>(아저씨, 이번에도 좀 빌릴게.)</speed>"
      - say:
          text: "<speed=66>퓻-!</speed> <speed=34>잠자는 코고로 모드, 개시.</speed>"
      - effect: pulse
      - add:
          final_confidence: 1
      - goto: readiness_gate

  readiness_gate:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: clue_mechanical_trick
                    op: eq
                    value: true
                  - var: clue_time_contradiction
                    op: eq
                    value: true
                  - var: clue_reiko_temp
                    op: eq
                    value: true
                  - var: clue_kenji_alibi
                    op: eq
                    value: true
                  - var: clue_shinichi_keylog
                    op: eq
                    value: true
              goto: ready_line
          default: not_ready_line

  ready_line:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>좋아.</speed> <speed=34>핵심 퍼즐 조각은 갖췄다. 이제 순서대로 답해.</speed>"
      - goto: trick_choice

  not_ready_line:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>아직 결론에 들어갈 준비가 부족해.</speed> <speed=56>탐문 라운지로 돌아가 빈칸을 메우자.</speed>"
      - goto: /routes/hub/1.yaml

  trick_choice:
    actions:
      - bg: tea_room
      - say:
          char: 코난.serious
          text: "<speed=40>1단계.</speed> <speed=34>밀실에서 독이 작동한 기계 트릭은?</speed>"
      - choice:
          key: final_trick_choice
          prompt: "살해 트릭을 고르자."
          options:
            - text: "밸브 속 얼린 독 캡슐의 지연 용출"
              set:
                trick_answer: "밸브_지연캡슐"
              add:
                deduction_score: 2
              goto: trick_correct
            - text: "뚜껑 두 번 누를 때 즉시 독 투입"
              set:
                trick_answer: "즉시투입"
              goto: trick_wrong
            - text: "주전자 전체에 독을 미리 혼합"
              set:
                trick_answer: "전체혼합"
              goto: trick_wrong

  trick_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=56>정답.</speed> <speed=34>지연 용출이라서 밀실 안에서 뒤늦게 발현됐다.</speed>"
      - goto: time_input

  trick_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(트릭 해석 실패...)</speed> <speed=58>이 추리로는 사건이 닫히지 않는다.</speed>"
      - goto: bad_epilogue

  time_input:
    actions:
      - input:
          prompt: "2단계. 알리바이를 무너뜨리는 결정 시각은? (24시간 형식)"
          correct: "21:28"
          saveAs: timeline_answer
          errors:
            - "21시 30분 직전, 괘종시계 사진을 떠올려."
            - "힌트: 21:28"
            - "정답은 21:28."
          routes:
            - equals: "21:28"
              add:
                deduction_score: 2
                final_confidence: 1
              goto: time_correct
            - equals: "21:30"
              goto: time_wrong
            - equals: "21:26"
              goto: time_wrong
            - equals: "21:27"
              goto: time_wrong

  time_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>맞아.</speed> <speed=34>21:28에 레이코의 알리바이는 깨진다.</speed>"
      - goto: culprit_choice

  time_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(시간 모순을 못 맞췄다...)</speed> <speed=58>결정타가 사라졌다.</speed>"
      - goto: bad_epilogue

  culprit_choice:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=46>3단계.</speed> <speed=34>이제 진범을 지목해.</speed>"
      - choice:
          key: final_culprit_choice
          prompt: "진범은 누구인가?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                deduction_score: 2
              goto: culprit_correct
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              goto: culprit_wrong
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              goto: culprit_wrong

  culprit_correct:
    actions:
      - say:
          char: 코난.serious
          with:
            - 레이코.nervous
          text: "<speed=56>레이코.</speed> <speed=34>네가 만든 시간표가 너를 배신했다.</speed>"
      - goto: motive_choice

  culprit_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(오지목이다...)</speed> <speed=58>이 선택은 사건을 잘못 봉인한다.</speed>"
      - goto: bad_epilogue

  motive_choice:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=44>4단계.</speed> <speed=34>범행 동기까지 맞춰야 완성이다.</speed>"
      - choice:
          key: final_motive_choice
          prompt: "레이코의 핵심 동기는?"
          options:
            - text: "하루오의 폭로를 막기 위해 연구노트 위조를 숨기려 했다"
              set:
                motive_answer: "폭로저지"
              add:
                deduction_score: 2
                trust: 1
              goto: motive_correct
            - text: "켄지와의 연애 갈등 보복"
              set:
                motive_answer: "연애보복"
              goto: motive_wrong
            - text: "단순 실수 은폐"
              set:
                motive_answer: "실수은폐"
              goto: motive_wrong

  motive_correct:
    actions:
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=24>...하루오 씨가 내 위조 장부를 경찰에 넘기겠다고 했어요.</speed>"
      - goto: verdict_branch

  motive_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(동기 해석 실패...)</speed> <speed=58>진실의 마지막 고리가 끊겼다.</speed>"
      - goto: bad_epilogue

  verdict_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: trick_answer
                    op: eq
                    value: "밸브_지연캡슐"
                  - var: timeline_answer
                    op: eq
                    value: "21:28"
                  - var: motive_answer
                    op: eq
                    value: "폭로저지"
                  - var: clue_fake_2r
                    op: eq
                    value: true
                  - var: clue_umbrella_decoy
                    op: eq
                    value: true
                  - var: clue_motive_contract
                    op: eq
                    value: true
                  - var: deduction_score
                    op: gte
                    value: 12
                  - var: mistake_count
                    op: lte
                    value: 4
              goto: true_epilogue
          default: normal_epilogue

  true_epilogue:
    actions:
      - bg: mountain_rain
      - music: solvethecase
      - effect: zoom
      - say:
          char: 코난.serious
          text: "<speed=34>레이코는 21:27 타이머를 다시 맞추고,</speed> <speed=30>밸브 속 얼린 독 캡슐이 21:28 이후 녹아 2번 잔 가장자리로 흘러들게 했다.</speed>"
      - say:
          char: 코난.serious
          text: '<speed=34>"2R"은 유언이 아니라 R2 각인을 뒤집은 미끼.</speed> <speed=62>빨간 섬유도 공용 우산함의 레드헤링이었다.</speed>'
      - use: residue_report
      - use: reiko_temp_log
      - use: kitchen_timer_note
      - use: corridor_clock_photo
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=22>...전부 맞아요.</speed> <speed=20>하루오 씨가 폭로하면 제 연구도, 제 아버지의 이름도 끝난다고 믿었어요.</speed>"
      - music: confession
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "<speed=28>지키고 싶었던 마음이...</speed> <speed=24>사람을 해치면 아무것도 남지 않아.</speed>"
      - ending: true_end

  normal_epilogue:
    actions:
      - bg: mountain_rain
      - music: reasoning
      - effect: blur
      - say:
          char: 코난.think
          text: "<speed=24>(범인은 밝혔지만, 몇 줄이 흐리다...)</speed> <speed=56>다음엔 빈틈 없이 잠근다.</speed>"
      - ending: normal_end

  bad_epilogue:
    actions:
      - bg: mountain_rain
      - music: reasoning
      - sound: thunder
      - effect: shake
      - say:
          char: 코난.think
          text: "<speed=24>(추리가 끊겼다...)</speed> <speed=58>밀실의 진실이 빗속으로 사라진다.</speed>"
      - ending: bad_end
