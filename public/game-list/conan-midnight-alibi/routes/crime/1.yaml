script:
  - scene: entry_guard
  - scene: first_intro
  - scene: revisit_intro
  - scene: fiber_item_gate
  - scene: fiber_item_get
  - scene: mark_probe
  - scene: mark_correct
  - scene: mark_wrong
  - scene: fiber_probe
  - scene: fiber_correct
  - scene: fiber_wrong
  - scene: revisit_question
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_crime
                op: eq
                value: true
              goto: revisit_intro
          default: first_intro

  first_intro:
    actions:
      - bg: tea_room
      - music: tension
      - set:
          visited_crime: true
      - add:
          exploration_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - sticker:
          id: crime_scene_lid
          image: clue_lid
          x: 50
          y: 43
          width: 56
          anchorX: center
          anchorY: center
          enter:
            effect: blurIn
      - say:
          char: 코난.serious
          text: "<speed=34>밀실 현장 재조사.</speed> <speed=30>2R, 섬유, 닦임 자국을 다시 본다.</speed>"
      - goto: fiber_item_gate

  revisit_intro:
    actions:
      - bg: tea_room
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "<speed=30>현장은 그대로다.</speed> <speed=56>놓친 포인트를 다시 집자.</speed>"
      - goto: revisit_question

  fiber_item_gate:
    actions:
      - branch:
          cases:
            - when:
                var: umbrella_fiber_note
                op: eq
                value: true
              goto: mark_probe
          default: fiber_item_get

  fiber_item_get:
    actions:
      - get: umbrella_fiber_note
      - sticker:
          id: item_popup_fiber_note
          image: police_tape
          x: 50
          y: 30
          width: 24
          enter:
            effect: popIn
          inputLockMs: 500
      - wait: 2300
      - say:
          char: 코난.think
          text: "<speed=34>빨간 섬유 감식 노트를 확보했다.</speed> <speed=56>채취 위치는 창가 하단.</speed>"
      - clearSticker:
          id: item_popup_fiber_note
          leave:
            effect: fadeOut
      - goto: mark_probe

  mark_probe:
    actions:
      - choice:
          key: crime_mark_probe
          prompt: '현장 "2R" 표기의 가장 타당한 해석은?'
          options:
            - text: "뚜껑 밸브 각인 R2를 뒤집어 심은 위장 표시"
              set:
                clue_fake_2r: true
              add:
                deduction_score: 1
              goto: mark_correct
            - text: "레이코 이니셜이므로 끝"
              add:
                mistake_count: 1
                trust: -1
              goto: mark_wrong
            - text: "피해자의 무의식적 낙서"
              add:
                mistake_count: 1
              goto: mark_wrong

  mark_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>좋아.</speed> <speed=34>다잉 메시지 자체가 함정 카드다.</speed>"
      - goto: fiber_probe

  mark_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(문자만 보면 미끼에 걸린다.)</speed>"
      - goto: fiber_probe

  fiber_probe:
    actions:
      - choice:
          key: crime_fiber_probe
          prompt: "빨간 섬유 단서는 어떻게 처리해야 할까?"
          options:
            - text: "공용 우산함 섬유라 단독 지목 증거로는 약하다"
              set:
                clue_umbrella_decoy: true
              add:
                deduction_score: 1
                final_confidence: 1
              goto: fiber_correct
            - text: "빨간 우산을 든 켄지의 직접 증거"
              add:
                mistake_count: 1
                trust: -1
              goto: fiber_wrong
            - text: "섬유 단서는 전부 무시한다"
              add:
                mistake_count: 1
              goto: fiber_wrong

  fiber_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=48>맞아.</speed> <speed=34>레드헤링은 버리고 시간선으로 간다.</speed>"
      - goto: outro

  fiber_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=26>섬유 단서 해석이 흔들린다.</speed> <speed=56>다른 라인으로 보강해야 해.</speed>"
      - goto: outro

  revisit_question:
    actions:
      - choice:
          key: crime_revisit_probe
          prompt: "현장에서 무엇을 다시 고정할까?"
          options:
            - text: '"2R"이 위장 표시인지 다시 확인한다'
              set:
                clue_fake_2r: true
              add:
                deduction_score: 1
              goto: outro
            - text: "빨간 섬유가 공용 우산함 기원인지 재확인한다"
              set:
                clue_umbrella_decoy: true
              add:
                final_confidence: 1
              goto: outro
            - text: "현장 정리 후 복귀"
              goto: outro

  outro:
    actions:
      - clearSticker:
          id: crime_scene_lid
          leave:
            effect: fadeOut
      - say:
          char: 코난
          text: "<speed=50>현장 재조사 종료.</speed> <speed=34>탐문 라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
