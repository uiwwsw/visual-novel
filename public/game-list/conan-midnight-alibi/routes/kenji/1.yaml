script:
  - scene: entry_guard
  - scene: first_intro
  - scene: revisit_intro
  - scene: item_gate
  - scene: item_get
  - scene: alibi_probe
  - scene: alibi_correct
  - scene: alibi_wrong
  - scene: fiber_probe
  - scene: fiber_correct
  - scene: fiber_wrong
  - scene: revisit_question
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_kenji
                op: eq
                value: true
              goto: revisit_intro
          default: first_intro

  first_intro:
    actions:
      - bg: rain_corridor
      - music: reasoning
      - set:
          visited_kenji: true
      - add:
          exploration_count: 1
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 켄지.angry
          with:
            - 코난.serious
          text: "<speed=52>난 화만 냈지 독은 안 넣었어!</speed> <speed=30>21:27엔 통화 중이었다고!</speed>"
      - say:
          char: 코난.serious
          text: "<speed=34>좋아.</speed> <speed=30>감정 말고 통화기록으로 확인하자.</speed>"
      - goto: item_gate

  revisit_intro:
    actions:
      - bg: rain_corridor
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "<speed=30>필요하면 기록 다시 보여 주지.</speed>"
      - goto: revisit_question

  item_gate:
    actions:
      - branch:
          cases:
            - when:
                var: kenji_call_record
                op: eq
                value: true
              goto: alibi_probe
          default: item_get

  item_get:
    actions:
      - get: kenji_call_record
      - sticker:
          id: item_popup_kenji_call
          image: case_board
          x: 50
          y: 30
          width: 24
          enter:
            effect: popIn
          inputLockMs: 500
      - wait: 2400
      - say:
          char: 코난.think
          text: "<speed=34>켄지 통화 기록을 확보했다.</speed> <speed=56>21:27 발신 로그가 선명하다.</speed>"
      - clearSticker:
          id: item_popup_kenji_call
          leave:
            effect: fadeOut
      - goto: alibi_probe

  alibi_probe:
    actions:
      - choice:
          key: kenji_alibi_probe
          prompt: "켄지 라인에서 먼저 확정할 사실은?"
          options:
            - text: "21:27 통화로 다실 실행 동선에서 잠시 이탈했다"
              set:
                clue_kenji_alibi: true
              add:
                deduction_score: 2
                trust: 1
              goto: alibi_correct
            - text: "화를 냈으니 즉시 범행했을 것이다"
              add:
                mistake_count: 1
                trust: -1
              goto: alibi_wrong
            - text: "목소리가 컸으니 오히려 침착했다"
              add:
                mistake_count: 1
              goto: alibi_wrong

  alibi_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>좋아.</speed> <speed=34>켄지는 동기 후보일 수 있어도 실행 시각은 비어 있다.</speed>"
      - goto: fiber_probe

  alibi_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=26>성격 추측은 증거가 아니다.</speed> <speed=58>시간표를 먼저 고정해.</speed>"
      - goto: fiber_probe

  fiber_probe:
    actions:
      - choice:
          key: kenji_fiber_probe
          prompt: "창가의 빨간 섬유는 무엇을 의미할까?"
          options:
            - text: "비상 우산함 공용 섬유라 단독 범인 지목 증거가 아니다"
              set:
                clue_umbrella_decoy: true
              add:
                deduction_score: 1
                final_confidence: 1
              goto: fiber_correct
            - text: "켄지 우산 색이 빨강이니 곧바로 켄지 확정"
              add:
                mistake_count: 1
                trust: -1
              goto: fiber_wrong
            - text: "섬유는 의미 없으니 폐기한다"
              add:
                mistake_count: 1
              goto: fiber_wrong

  fiber_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=48>맞아.</speed> <speed=34>이건 첫 번째 레드헤링이다.</speed>"
      - goto: outro

  fiber_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(섬유를 과대해석하면 함정에 빠진다.)</speed>"
      - goto: outro

  revisit_question:
    actions:
      - choice:
          key: kenji_revisit_probe
          prompt: "켄지에게 무엇을 재확인할까?"
          options:
            - text: "21:27 통화 로그를 다시 확인한다"
              set:
                clue_kenji_alibi: true
              add:
                deduction_score: 1
              goto: outro
            - text: "빨간 섬유가 공용 우산함 기원인지 확인한다"
              set:
                clue_umbrella_decoy: true
              add:
                final_confidence: 1
              goto: outro
            - text: "질문 종료"
              goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>켄지 라인 종료.</speed> <speed=34>탐문 라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
