script:
  - scene: entry_guard
  - scene: first_intro
  - scene: revisit_intro
  - scene: timer_item_gate
  - scene: timer_item_get
  - scene: valve_item_gate
  - scene: valve_item_get
  - scene: ice_item_gate
  - scene: ice_item_get
  - scene: trick_probe
  - scene: trick_correct
  - scene: trick_wrong
  - scene: time_input
  - scene: time_correct
  - scene: time_wrong
  - scene: revisit_question
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_kitchen
                op: eq
                value: true
              goto: revisit_intro
          default: first_intro

  first_intro:
    actions:
      - bg: rain_corridor
      - music: reasoning
      - set:
          visited_kitchen: true
      - add:
          exploration_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "<speed=34>주방 보일러실 조사.</speed> <speed=30>타이머와 뚜껑 밸브 구조를 본다.</speed>"
      - goto: timer_item_gate

  revisit_intro:
    actions:
      - bg: rain_corridor
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "<speed=28>주방은 기계 단서 창고다.</speed> <speed=56>놓친 구조를 다시 보자.</speed>"
      - goto: revisit_question

  timer_item_gate:
    actions:
      - branch:
          cases:
            - when:
                var: kitchen_timer_note
                op: eq
                value: true
              goto: valve_item_gate
          default: timer_item_get

  timer_item_get:
    actions:
      - get: kitchen_timer_note
      - sticker:
          id: item_popup_timer_note
          image: clue_cup
          x: 50
          y: 30
          width: 24
          enter:
            effect: popIn
          inputLockMs: 500
      - wait: 2300
      - say:
          char: 코난.think
          text: "<speed=34>주방 타이머 메모 확보.</speed> <speed=56>재설정 시각은 21:27.</speed>"
      - clearSticker:
          id: item_popup_timer_note
          leave:
            effect: fadeOut
      - goto: valve_item_gate

  valve_item_gate:
    actions:
      - branch:
          cases:
            - when:
                var: valve_sketch
                op: eq
                value: true
              goto: ice_item_gate
          default: valve_item_get

  valve_item_get:
    actions:
      - get: valve_sketch
      - sticker:
          id: item_popup_valve_sketch
          image: clue_lid
          x: 50
          y: 30
          width: 24
          enter:
            effect: popIn
          inputLockMs: 500
      - wait: 2300
      - say:
          char: 코난.think
          text: "<speed=34>주전자 밸브 스케치를 확보했다.</speed> <speed=56>구형 캡슐이 들어갈 틈이 있다.</speed>"
      - clearSticker:
          id: item_popup_valve_sketch
          leave:
            effect: fadeOut
      - goto: ice_item_gate

  ice_item_gate:
    actions:
      - branch:
          cases:
            - when:
                var: ice_bucket_note
                op: eq
                value: true
              goto: trick_probe
          default: ice_item_get

  ice_item_get:
    actions:
      - get: ice_bucket_note
      - sticker:
          id: item_popup_ice_note
          image: clue_cup
          x: 50
          y: 30
          width: 24
          enter:
            effect: popIn
          inputLockMs: 500
      - wait: 2300
      - say:
          char: 코난.think
          text: "<speed=34>얼음통 사용 기록 확보.</speed> <speed=56>구형 얼음 1개가 누락됐다.</speed>"
      - clearSticker:
          id: item_popup_ice_note
          leave:
            effect: fadeOut
      - goto: trick_probe

  trick_probe:
    actions:
      - choice:
          key: kitchen_trick_probe
          prompt: "주방 단서로 성립하는 물리 트릭은?"
          options:
            - text: "밸브 안에 얼린 독 캡슐을 숨겨 지연 용출시켰다"
              set:
                clue_mechanical_trick: true
              add:
                deduction_score: 3
                final_confidence: 1
              goto: trick_correct
            - text: "뚜껑 두 번 누를 때 즉시 독을 부었다"
              add:
                mistake_count: 1
              goto: trick_wrong
            - text: "주전자 자체에 독을 풀어 모두를 노렸다"
              add:
                mistake_count: 1
                trust: -1
              goto: trick_wrong

  trick_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=56>맞다.</speed> <speed=34>기계 트릭의 핵심은 지연 용출이다.</speed>"
      - goto: time_input

  trick_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=26>아직 메커니즘이 틀렸다.</speed> <speed=56>시각 단서와 함께 다시 맞춘다.</speed>"
      - goto: time_input

  time_input:
    actions:
      - input:
          prompt: "주방 타이머가 다시 맞춰진 시각은? (24시간 형식)"
          correct: "21:27"
          errors:
            - "21시 20분대 후반이다."
            - "힌트: 21:27"
            - "정답은 21:27."
          routes:
            - equals: "21:27"
              set:
                clue_reiko_temp: true
              add:
                deduction_score: 1
              goto: time_correct
            - equals: "21:24"
              add:
                mistake_count: 1
              goto: time_wrong
            - equals: "21:30"
              add:
                mistake_count: 1
              goto: time_wrong

  time_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>좋아.</speed> <speed=34>타이머 시각과 알리바이 진술이 정면충돌한다.</speed>"
      - goto: outro

  time_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(시각 고정 실패...)</speed> <speed=56>복도 라인에서 보강하자.</speed>"
      - goto: outro

  revisit_question:
    actions:
      - choice:
          key: kitchen_revisit_probe
          prompt: "주방에서 무엇을 다시 맞출까?"
          options:
            - text: "밸브-얼음 캡슐 지연 트릭을 재확인"
              set:
                clue_mechanical_trick: true
              add:
                deduction_score: 1
              goto: outro
            - text: "타이머 21:27 시각을 재확인"
              set:
                clue_reiko_temp: true
              add:
                final_confidence: 1
              goto: outro
            - text: "질문 종료"
              goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>주방 라인 종료.</speed> <speed=34>탐문 라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
