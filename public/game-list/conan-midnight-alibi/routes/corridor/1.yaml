script:
  - scene: entry_guard
  - scene: first_intro
  - scene: revisit_intro
  - scene: clock_item_gate
  - scene: clock_item_get
  - scene: time_input
  - scene: time_correct
  - scene: time_wrong
  - scene: contradiction_probe
  - scene: contradiction_correct
  - scene: contradiction_wrong
  - scene: revisit_question
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_corridor
                op: eq
                value: true
              goto: revisit_intro
          default: first_intro

  first_intro:
    actions:
      - bg: rain_corridor
      - music: rain
      - set:
          visited_corridor: true
      - add:
          exploration_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 란
          position: left
          emotion: worried
      - say:
          char: 코난.serious
          text: "<speed=34>복도 시계 라인 조사.</speed> <speed=30>알리바이를 부수는 건 분 단위 시각이다.</speed>"
      - goto: clock_item_gate

  revisit_intro:
    actions:
      - bg: rain_corridor
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "<speed=28>복도는 시간 단서가 살아 있는 곳.</speed> <speed=56>다시 맞춰 보자.</speed>"
      - goto: revisit_question

  clock_item_gate:
    actions:
      - branch:
          cases:
            - when:
                var: corridor_clock_photo
                op: eq
                value: true
              goto: time_input
          default: clock_item_get

  clock_item_get:
    actions:
      - get: corridor_clock_photo
      - sticker:
          id: item_popup_clock_photo
          image: rain_corridor
          x: 50
          y: 32
          width: 30
          enter:
            effect: popIn
          inputLockMs: 500
      - wait: 2300
      - say:
          char: 코난.think
          text: "<speed=34>복도 시계 사진 확보.</speed> <speed=56>시곗바늘은 21:28을 가리킨다.</speed>"
      - clearSticker:
          id: item_popup_clock_photo
          leave:
            effect: fadeOut
      - goto: time_input

  time_input:
    actions:
      - input:
          prompt: "알리바이를 깨는 복도 시각은? (24시간 형식)"
          correct: "21:28"
          saveAs: timeline_answer
          errors:
            - "21시 30분 직전이다."
            - "힌트: 21:28"
            - "정답은 21:28."
          routes:
            - equals: "21:28"
              set:
                clue_time_contradiction: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: time_correct
            - equals: "21:30"
              add:
                mistake_count: 1
              goto: time_wrong
            - equals: "21:24"
              add:
                mistake_count: 1
              goto: time_wrong
            - equals: "21:26"
              add:
                mistake_count: 1
              goto: time_wrong

  time_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>정확해.</speed> <speed=34>21:28은 누군가의 '홀에 있었다' 진술을 깨뜨린다.</speed>"
      - goto: contradiction_probe

  time_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(시각이 틀렸다.)</speed> <speed=58>한 번 더 논리로 걸러 보자.</speed>"
      - goto: contradiction_probe

  contradiction_probe:
    actions:
      - choice:
          key: corridor_contradiction_probe
          prompt: "21:28 단서가 직접 겨누는 모순은?"
          options:
            - text: "레이코의 '계속 홀에 있었다' 진술"
              set:
                clue_time_contradiction: true
              add:
                deduction_score: 1
                trust: 1
              goto: contradiction_correct
            - text: "켄지의 21:27 통화 알리바이"
              add:
                mistake_count: 1
              goto: contradiction_wrong
            - text: "신이치의 21:26 키로그"
              add:
                mistake_count: 1
              goto: contradiction_wrong

  contradiction_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=50>좋아.</speed> <speed=34>시간 모순의 칼끝은 레이코를 향한다.</speed>"
      - goto: outro

  contradiction_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(시간선 포커스가 엇나갔다.)</speed>"
      - goto: outro

  revisit_question:
    actions:
      - choice:
          key: corridor_revisit_probe
          prompt: "복도 라인에서 무엇을 재확인할까?"
          options:
            - text: "21:28 시각을 다시 고정한다"
              set:
                clue_time_contradiction: true
              add:
                deduction_score: 1
              goto: outro
            - text: "21:28이 레이코 진술과 충돌함을 다시 확인한다"
              set:
                clue_time_contradiction: true
              add:
                final_confidence: 1
              goto: outro
            - text: "이번엔 여기까지"
              goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>복도 시계 라인 종료.</speed> <speed=34>탐문 라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
