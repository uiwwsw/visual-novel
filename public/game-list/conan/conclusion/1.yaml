script:
  - scene: final_intro
  - scene: sleeping_kogoro
  - scene: reasoning_tone_branch
  - scene: sharp_reasoning
  - scene: cautious_reasoning
  - scene: coverage_branch
  - scene: full_coverage_line
  - scene: partial_coverage_line
  - scene: early_exit_line
  - scene: final_accuse_gate
  - scene: accuse_confirm_reiko
  - scene: accuse_confirm_other
  - scene: wrong_answer_check
  - scene: comeback_gate
  - scene: verdict_branch
  - scene: true_epilogue
  - scene: normal_epilogue
  - scene: bad_epilogue

scenes:
  final_intro:
    actions:
      - bg: case_board
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "<speed=48>좋아, 전원 집합.</speed> <speed=34>하루오 씨를 죽인 트릭을 지금 끝낸다.</speed>"
      - wait: 300
      - say:
          char: 코난.think
          text: '<speed=26>(뚜껑 두 번은 연막.)</speed> <speed=30>핵심은 컵 가장자리 반응, 닦인 자국, 그리고 "2R".</speed>'
      - goto: sleeping_kogoro

  sleeping_kogoro:
    actions:
      - bg: ryokan_hall
      - char:
          id: 코고로
          position: left
          emotion: proud
      - char:
          id: 코난
          position: center
          emotion: think
      - effect: flash
      - sound: door
      - say:
          char: 코난.think
          with:
            - 코고로.angry
          text: "<speed=24>(아저씨, 잠깐 빌릴게.)</speed> <speed=64>진실은 지금 말해야 한다.</speed>"
      - say:
          text: "<speed=64>퓻-!</speed> <speed=32>작은 소리와 함께 코고로가 천천히 눈을 감는다.</speed>"
      - effect: pulse
      - say:
          text: "<speed=70>챙-!</speed> <speed=40>잠자는 코고로의 무대가 열린다.</speed>"
      - add:
          final_confidence: 1
      - goto: reasoning_tone_branch

  reasoning_tone_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: final_confidence
                    op: gte
                    value: 5
                  - var: trust
                    op: gte
                    value: 2
              goto: sharp_reasoning
          default: cautious_reasoning

  sharp_reasoning:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "<speed=44>이건 사고가 아니다.</speed> <speed=34>독은 찻물보다 먼저, 2번 잔 가장자리에서 반응했다.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=34>주전자 뚜껑 두 번은 시선을 빼앗는 연막.</speed> <speed=62>진짜 작업은 그 직후 닦인 자국에서 일어났다.</speed>"
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: '<speed=34>즉, "2R"은 단독 유언이 아니라 유도된 프레임일 가능성이 높군요.</speed>'
      - goto: coverage_branch

  cautious_reasoning:
    actions:
      - effect: darken
      - say:
          char: 코난.think
          text: "<speed=30>핵심은 같다.</speed> <speed=26>가장자리 반응과 닦임 자국을 함께 봐야 한다.</speed>"
      - say:
          char: 란.worried
          with:
            - 코난.think
          text: "<speed=30>그럼 메시지를 남긴 사람과, 메시지를 손본 사람이 다를 수도 있네...</speed>"
      - goto: coverage_branch

  coverage_branch:
    actions:
      - branch:
          cases:
            - when:
                var: investigation_count
                op: gte
                value: 4
              goto: full_coverage_line
          default: partial_coverage_line

  full_coverage_line:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=54>네 라인 전부 검증 완료.</speed> <speed=34>이제 반박 여지는 없다.</speed>"
      - goto: final_accuse_gate

  partial_coverage_line:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(아직 빈칸이 있다...)</speed> <speed=58>지목은 더 신중해야 한다.</speed>"
      - branch:
          cases:
            - when:
                var: early_exit_taken
                op: eq
                value: true
              goto: early_exit_line
          default: final_accuse_gate

  early_exit_line:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>중간에 끊고 온 대가가 남아 있어.</speed> <speed=58>그래도 가진 증거로 끝까지 간다.</speed>"
      - goto: final_accuse_gate

  final_accuse_gate:
    actions:
      - bg: tea_room
      - music: reasoning
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "<speed=64>이제 지목한다.</speed> <speed=34>하루오 씨를 죽음으로 몰아넣은 건 누구지?</speed>"
      - choice:
          key: final_accuse
          prompt: "모든 단서를 종합했을 때 범인은?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                final_confidence: 1
              goto: accuse_confirm_reiko
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              add:
                mistake_count: 1
                trust: -1
              goto: accuse_confirm_other
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              add:
                mistake_count: 1
                trust: -1
              goto: accuse_confirm_other
            - text: "하루오"
              set:
                culprit_answer: "하루오"
              add:
                mistake_count: 1
                trust: -1
              goto: accuse_confirm_other

  accuse_confirm_reiko:
    actions:
      - say:
          char: 코난.serious
          with:
            - 레이코.nervous
          text: "<speed=56>레이코, 너다.</speed> <speed=34>이 지목을 확정한다.</speed>"
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=24>...정말, 끝까지 그렇게 믿어요?</speed>"
      - choice:
          key: final_accuse_confirm_reiko
          prompt: "레이코 지목을 확정할까?"
          options:
            - text: "확정한다"
              goto: verdict_branch
            - text: "다시 생각한다"
              add:
                final_confidence: -1
              goto: final_accuse_gate

  accuse_confirm_other:
    actions:
      - say:
          char: 코난.think
          text: "<speed=30>그 이름으로 끝까지 갈 거야?</speed> <speed=58>지금 틀리면 사건은 닫히지 않는다.</speed>"
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "<speed=30>오지목 확정 시 되돌리기 어렵습니다.</speed>"
      - choice:
          key: final_accuse_confirm_other
          prompt: "이 지목을 어떻게 할까?"
          options:
            - text: "틀렸다. 다시 지목"
              add:
                final_confidence: -1
              goto: final_accuse_gate
            - text: "이 지목으로 밀어붙인다"
              goto: wrong_answer_check

  wrong_answer_check:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(아직 끝난 게 아냐...)</speed> <speed=58>한 번만 바로잡을 기회가 있다.</speed>"
      - branch:
          cases:
            - when:
                all:
                  - var: comeback_chance
                    op: gte
                    value: 1
                  - var: deduction_score
                    op: gte
                    value: 5
                  - var: mistake_count
                    op: lte
                    value: 4
              goto: comeback_gate
          default: bad_epilogue

  comeback_gate:
    actions:
      - set:
          comeback_chance: 0
      - say:
          char: 코난.serious
          text: "<speed=56>마지막 재지목이다.</speed> <speed=34>이번에 틀리면 끝이야.</speed>"
      - choice:
          key: final_comeback
          prompt: "재지목 1회: 최종 범인은?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                deduction_score: 1
                trust: 1
                final_confidence: 1
              goto: verdict_branch
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "하루오"
              set:
                culprit_answer: "하루오"
              add:
                mistake_count: 1
              goto: bad_epilogue

  verdict_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: deduction_score
                    op: gte
                    value: 10
                  - var: mistake_count
                    op: lte
                    value: 2
                  - var: trust
                    op: gte
                    value: 2
                  - var: final_confidence
                    op: gte
                    value: 6
                  - var: clue_rim_reagent
                    op: eq
                    value: true
                  - var: clue_haruo_wipe
                    op: eq
                    value: true
                  - var: clue_order_note
                    op: eq
                    value: true
                  - var: reiko_motive_open
                    op: eq
                    value: true
              goto: true_epilogue
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: deduction_score
                    op: gte
                    value: 6
                  - var: final_confidence
                    op: gte
                    value: 3
                  - var: mistake_count
                    op: lte
                    value: 5
              goto: normal_epilogue
          default: bad_epilogue

  true_epilogue:
    actions:
      - bg: mountain_rain
      - music: solvethecase
      - effect: zoom
      - say:
          char: 코난.serious
          text: '<speed=36>2번 잔 반응, 닦임 자국, "2R" 위조, 계약서 수정 시각.</speed> <speed=64>모든 선이 레이코에게 닿는다.</speed>'
      - use: tea_residue_report
      - use: reiko_statement_note
      - set:
          item_tea_residue_report_owned: false
          item_reiko_statement_note_owned: false
      - say:
          char: 코난.serious
          text: "<speed=34>시료 카드와 진술 메모를 증거 보드에 펼친다.</speed> <speed=62>이제 빠져나갈 빈틈은 없어.</speed>"
      - music: confession
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=24>...하루오 씨는 제 계획을 눈치챘어요.</speed> <speed=20>연구를 빼앗긴다는 공포에,</speed> <speed=58>저는 사람을 지웠어요.</speed>"
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=22>아버지의 마지막 노트를 지키고 싶었는데...</speed> <speed=54>결국 제가 가장 더럽혔네요.</speed>"
      - music: solvethecase
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "<speed=30>지키고 싶다는 마음이...</speed> <speed=26>어떻게 이렇게 비극이 될 수 있어...</speed>"
      - ending: true_end

  normal_epilogue:
    actions:
      - bg: mountain_rain
      - music: reasoning
      - effect: blur
      - say:
          char: 코난.think
          text: "<speed=24>(범인은 맞췄지만 빈틈이 남았다.)</speed> <speed=58>진실을 완전히 잠그진 못했어.</speed>"
      - say:
          char: 코고로.angry
          with:
            - 코난.think
          text: "<speed=44>크흠!</speed> <speed=30>그래도 여기까지 온 건 대단한 성과다!</speed>"
      - ending: normal_end

  bad_epilogue:
    actions:
      - bg: mountain_rain
      - music: reasoning
      - sound: thunder
      - effect: shake
      - say:
          char: 코난.think
          text: "<speed=24>(단서 연결이 끊겼다...)</speed> <speed=58>이 상태론 누구도 납득시키지 못해.</speed>"
      - ending: bad_end
