script:
  - scene: final_intro
  - scene: sleeping_kogoro
  - scene: reasoning_tone_branch
  - scene: sharp_reasoning
  - scene: cautious_reasoning
  - scene: coverage_branch
  - scene: full_coverage_line
  - scene: partial_coverage_line
  - scene: early_exit_line
  - scene: final_accuse_gate
  - scene: wrong_answer_check
  - scene: comeback_gate
  - scene: verdict_branch
  - scene: true_epilogue
  - scene: normal_epilogue
  - scene: bad_epilogue

scenes:
  final_intro:
    actions:
      - bg: case_board
      - music: mystery
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "이제 집합 추리다. 단서들을 한 줄로 묶어야 해."
      - wait: 340
      - say:
          char: 코난.think
          text: "(뚜껑 두 번은 미끼, 핵심은 찻잔 가장자리 반응... 그리고 동기 문서.)"
      - goto: sleeping_kogoro

  sleeping_kogoro:
    actions:
      - bg: ryokan_hall
      - char:
          id: 코고로
          position: left
          emotion: proud
      - char:
          id: 코난
          position: center
          emotion: think
      - effect: flash
      - sound: door
      - say:
          text: "순간, 회의실 공기가 멎었다. 모두가 코고로의 다음 한마디를 기다렸다."
      - say:
          char: 코난.think
          with:
            - 코고로.angry
          text: "(아저씨, 이번에도 잠깐만 빌릴게.)"
      - add:
          final_confidence: 1
      - goto: reasoning_tone_branch

  reasoning_tone_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: final_confidence
                    op: gte
                    value: 5
                  - var: trust
                    op: gte
                    value: 2
              goto: sharp_reasoning
          default: cautious_reasoning

  sharp_reasoning:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "독은 찻물에 직접 들어간 게 아니다. 찻잔 가장자리의 시약 반응이 핵심이었다."
      - say:
          char: 코난.serious
          text: "뚜껑을 두 번 누른 동작은 시선을 빼앗기 위한 미끼였어."
      - goto: coverage_branch

  cautious_reasoning:
    actions:
      - effect: darken
      - say:
          char: 코난.think
          text: "핵심 축은 같다. 찻잔 가장자리 반응과 미끼 동작을 함께 봐야 한다."
      - say:
          char: 란.worried
          with:
            - 코난.think
          text: "그럼 범인은 반응 시점과 잔 순서를 동시에 알고 있던 사람이네..."
      - goto: coverage_branch

  coverage_branch:
    actions:
      - branch:
          cases:
            - when:
                var: investigation_count
                op: gte
                value: 4
              goto: full_coverage_line
          default: partial_coverage_line

  full_coverage_line:
    actions:
      - say:
          char: 코난.serious
          text: "네 명 대면을 모두 마쳤다. 이제 빈칸은 없다."
      - goto: final_accuse_gate

  partial_coverage_line:
    actions:
      - say:
          char: 코난.think
          text: "아직 비어 있는 대면 축이 있다. 마지막 선택은 더 신중해야 해."
      - branch:
          cases:
            - when:
                var: early_exit_taken
                op: eq
                value: true
              goto: early_exit_line
          default: final_accuse_gate

  early_exit_line:
    actions:
      - say:
          char: 코난.think
          text: "중간 정리로 일찍 넘어온 대가를 감수하더라도, 지금 가진 증거로 끝까지 간다."
      - goto: final_accuse_gate

  final_accuse_gate:
    actions:
      - bg: tea_room
      - music: tension
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: serious
      - choice:
          key: final_accuse
          prompt: "모든 단서를 종합했을 때 범인은 누구인가?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                final_confidence: 1
              goto: verdict_branch
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              add:
                mistake_count: 1
                trust: -1
              goto: wrong_answer_check
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              add:
                mistake_count: 1
                trust: -1
              goto: wrong_answer_check
            - text: "하루오"
              set:
                culprit_answer: "하루오"
              add:
                mistake_count: 1
                trust: -1
              goto: wrong_answer_check

  wrong_answer_check:
    actions:
      - say:
          char: 코난.think
          text: "(아직 끝은 아니야. 단 한 번, 정정 기회가 남아 있어.)"
      - branch:
          cases:
            - when:
                all:
                  - var: comeback_chance
                    op: gte
                    value: 1
                  - var: deduction_score
                    op: gte
                    value: 5
                  - var: mistake_count
                    op: lte
                    value: 4
              goto: comeback_gate
          default: bad_epilogue

  comeback_gate:
    actions:
      - set:
          comeback_chance: 0
      - choice:
          key: final_comeback
          prompt: "재지목 기회(1회). 최종 범인은?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                deduction_score: 1
                trust: 1
                final_confidence: 1
              goto: verdict_branch
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "하루오"
              set:
                culprit_answer: "하루오"
              add:
                mistake_count: 1
              goto: bad_epilogue

  verdict_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: deduction_score
                    op: gte
                    value: 10
                  - var: mistake_count
                    op: lte
                    value: 2
                  - var: trust
                    op: gte
                    value: 2
                  - var: final_confidence
                    op: gte
                    value: 6
                  - var: clue_rim_reagent
                    op: eq
                    value: true
                  - var: clue_haruo_wipe
                    op: eq
                    value: true
                  - var: clue_order_note
                    op: eq
                    value: true
                  - var: reiko_motive_open
                    op: eq
                    value: true
              goto: true_epilogue
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: deduction_score
                    op: gte
                    value: 6
                  - var: final_confidence
                    op: gte
                    value: 3
                  - var: mistake_count
                    op: lte
                    value: 5
              goto: normal_epilogue
          default: bad_epilogue

  true_epilogue:
    actions:
      - bg: mountain_rain
      - music: rain
      - effect: zoom
      - say:
          char: 코난.serious
          text: "잔 가장자리 반응, 잔 순서 메모, 닦는 동작, 계약서 수정 시각... 전부 레이코를 가리켰어."
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "...연구를 빼앗긴다고 생각한 순간, 돌이킬 선을 넘었어요."
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "차 한 잔의 습관이 결국 진실을 열었네..."
      - ending: true_end

  normal_epilogue:
    actions:
      - bg: mountain_rain
      - music: rain
      - effect: blur
      - say:
          char: 코난.think
          text: "범인은 맞췄다. 하지만 몇 개의 빈칸이 진실의 무게를 가볍게 만들었어."
      - say:
          char: 코고로.angry
          with:
            - 코난.think
          text: "크흠... 그래도 결론은 제대로 도착했으니 된 거지!"
      - ending: normal_end

  bad_epilogue:
    actions:
      - bg: mountain_rain
      - music: tension
      - sound: thunder
      - effect: shake
      - say:
          char: 코난.think
          text: "단서 사슬이 끊겼다... 이 상태로는 누구도 완전히 납득시킬 수 없어."
      - say:
          text: "폭우가 그친 뒤에도, 다실의 비밀은 흐린 채 남았다."
      - ending: bad_end
