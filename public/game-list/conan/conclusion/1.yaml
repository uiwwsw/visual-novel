meta:
  title: "명탐정 코난 외전: 다실의 비밀"
  author: "uiwwsw"
  version: "4.0"

settings:
  textSpeed: 38
  autoSave: true
  clickToInstant: true

assets:
  backgrounds:
    mountain_rain: ../assets/bg/mountain_rain.png
    ryokan_hall: ../assets/bg/ryokan_hall.png
    tea_room: ../assets/bg/tea_room.png

  characters:
    코난:
      base: ../assets/char/conan/base.png
      emotions:
        think: ../assets/char/conan/think.png
        serious: ../assets/char/conan/serious.png

    신이치:
      base: ../assets/char/shinichi/base.png
      emotions:
        cold: ../assets/char/shinichi/cold.png

    레이코:
      base: ../assets/char/reiko/base.png
      emotions:
        nervous: ../assets/char/reiko/nervous.png

    코고로:
      base: ../assets/char/kogoro/base.png
      emotions:
        angry: ../assets/char/kogoro/angry.png

  music:
    rain: ../assets/music/rain.wav
    mystery: ../assets/music/mystery.wav
    tension: ../assets/music/tension.wav

  sfx:
    thunder: ../assets/sfx/thunder.wav

state:
  defaults:
    trust: 0
    truth_point: 0
    mistake_count: 0
    comeback_chance: 1
    route_origin: ""
    suspect: ""
    culprit_answer: ""

endings:
  true_end:
    title: "TRUE END"
    message: "모든 선택의 오류를 교정하고, 완전한 진실에 도달했다."
  normal_end:
    title: "NORMAL END"
    message: "핵심 진실은 밝혔지만, 흔들린 순간들이 여운으로 남았다."
  bad_end:
    title: "BAD END"
    message: "누적된 오판이 끝내 결론을 무너뜨렸다."

endingRules:
  - when:
      all:
        - var: culprit_answer
          op: eq
          value: "신이치"
        - var: truth_point
          op: gte
          value: 4
        - var: trust
          op: gte
          value: 3
        - var: mistake_count
          op: lte
          value: 1
    ending: true_end
  - when:
      all:
        - var: culprit_answer
          op: eq
          value: "신이치"
        - var: truth_point
          op: gte
          value: 2
        - var: mistake_count
          op: lte
          value: 2
    ending: normal_end

defaultEnding: bad_end

script:
  - scene: precheck
  - scene: final_accuse_gate
  - scene: wrong_answer_check
  - scene: comeback_intro
  - scene: comeback_gate
  - scene: verdict_path
  - scene: ending_roll

scenes:
  precheck:
    actions:
      - bg: tea_room
      - music: mystery
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          text: "결론 챕터 - 마지막 회의"
      - branch:
          cases:
            - when:
                var: mistake_count
                op: gte
                value: 3
              goto: hard_fail
          default: final_accuse_gate

  hard_fail:
    actions:
      - bg: ryokan_hall
      - music: tension
      - sound: thunder
      - effect: shake
      - say:
          text: "핵심 실수가 너무 많이 누적되어, 결론 회의는 시작부터 붕괴했다."
      - ending: bad_end

  final_accuse_gate:
    actions:
      - bg: ryokan_hall
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - choice:
          key: conclusion_final_accuse
          prompt: "최종 지목. 누가 밀실 트릭을 실행했나?"
          options:
            - text: "신이치"
              set:
                culprit_answer: "신이치"
                suspect: "신이치"
              goto: verdict_path
            - text: "레이코"
              set:
                culprit_answer: "레이코"
                suspect: "레이코"
              add:
                mistake_count: 1
                trust: -1
              goto: wrong_answer_check

  wrong_answer_check:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: comeback_chance
                    op: gte
                    value: 1
                  - var: truth_point
                    op: gte
                    value: 2
                  - var: mistake_count
                    op: lte
                    value: 2
              goto: comeback_intro
          default: final_bad

  comeback_intro:
    actions:
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난
          text: "아직 논리가 완전히 끊기진 않았어. 딱 한 번만 더 지목해."
      - set:
          comeback_chance: 0
      - goto: comeback_gate

  comeback_gate:
    actions:
      - choice:
          key: conclusion_comeback
          prompt: "재지목 기회(1회). 최종 범인은?"
          options:
            - text: "신이치"
              set:
                culprit_answer: "신이치"
                suspect: "신이치"
              add:
                truth_point: 1
                trust: 1
              goto: verdict_path
            - text: "레이코"
              set:
                culprit_answer: "레이코"
                suspect: "레이코"
              add:
                mistake_count: 1
              goto: final_bad

  final_bad:
    actions:
      - bg: mountain_rain
      - music: tension
      - effect: darken
      - say:
          text: "재기회마저 놓치며, 진실은 끝내 흐릿해졌다."
      - ending: bad_end

  verdict_path:
    actions:
      - char:
          id: 코고로
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "문틈 줄 트릭과 외투의 찻잎. 답은 하나야."
      - goto: ending_roll

  ending_roll:
    actions:
      - bg: mountain_rain
      - music: rain
      - say:
          text: "새벽 공기 속에서 사건의 결말이 조용히 내려앉았다."
      - say:
          text: "이후 엔딩은 당신이 쌓아온 선택의 누적으로 판정된다."
