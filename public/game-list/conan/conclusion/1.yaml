script:
  - scene: final_intro
  - scene: sleeping_kogoro
  - scene: reasoning_tone_branch
  - scene: kogoro_voice_sharp
  - scene: kogoro_voice_shaky
  - scene: final_accuse_gate
  - scene: wrong_answer_check
  - scene: comeback_gate
  - scene: verdict_branch
  - scene: true_epilogue
  - scene: normal_epilogue
  - scene: bad_epilogue

scenes:
  final_intro:
    actions:
      - bg: tea_room
      - music: mystery
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "이제 결론이다. 밀실 트릭은 이미 틀이 잡혔어."
      - wait: 380
      - say:
          char: 코난.think
          text: "(한 번에 끝낸다. 흔들리면 여기서 전부 무너져.)"
      - goto: sleeping_kogoro

  sleeping_kogoro:
    actions:
      - bg: ryokan_hall
      - char:
          id: 코고로
          position: left
          emotion: proud
      - char:
          id: 코난
          position: center
          emotion: think
      - effect: flash
      - sound: door
      - say:
          text: "순간, 코고로의 목소리가 멎고 회의장은 숨을 삼켰다."
      - say:
          char: 코난.think
          with:
            - 코고로.angry
          text: "(아저씨, 이번에도 잠깐만 빌릴게.)"
      - add:
          final_confidence: 1
      - goto: reasoning_tone_branch

  reasoning_tone_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: final_confidence
                    op: gte
                    value: 5
                  - var: trust
                    op: gte
                    value: 2
              goto: kogoro_voice_sharp
          default: kogoro_voice_shaky

  kogoro_voice_sharp:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "독은 찻잔에 탄 게 아니다. 주전자 뚜껑 안쪽에서 떨어졌다."
      - say:
          char: 코난.serious
          text: "그리고 피해자 잔의 순서를 알고 있던 사람만 이 트릭을 쓸 수 있어."
      - goto: final_accuse_gate

  kogoro_voice_shaky:
    actions:
      - effect: darken
      - say:
          char: 코난.think
          text: "핵심은 같다. 독은 뚜껑 안쪽... 다만 아직 연결 고리를 더 보여줘야 해."
      - say:
          char: 란.worried
          with:
            - 코난.think
          text: "코난... 아니, 아빠 말이 맞다면 범인은 잔 순서를 알고 있던 사람이라는 거지?"
      - goto: final_accuse_gate

  final_accuse_gate:
    actions:
      - bg: tea_room
      - music: tension
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: serious
      - choice:
          key: final_accuse
          prompt: "밀실 트릭을 실행한 범인은 누구인가?"
          options:
            - text: "신이치"
              set:
                culprit_answer: "신이치"
                suspect: "신이치"
              add:
                final_confidence: 1
              goto: verdict_branch
            - text: "레이코"
              set:
                culprit_answer: "레이코"
                suspect: "레이코"
              add:
                mistake_count: 1
                trust: -1
              goto: wrong_answer_check
            - text: "켄지"
              set:
                culprit_answer: "켄지"
                suspect: "켄지"
              add:
                mistake_count: 1
                trust: -1
              goto: wrong_answer_check

  wrong_answer_check:
    actions:
      - say:
          char: 코난.think
          text: "(아직은 끝이 아니야. 단 한 번, 정정 기회가 남아 있다.)"
      - branch:
          cases:
            - when:
                all:
                  - var: comeback_chance
                    op: gte
                    value: 1
                  - var: truth_point
                    op: gte
                    value: 5
                  - var: mistake_count
                    op: lte
                    value: 4
              goto: comeback_gate
          default: bad_epilogue

  comeback_gate:
    actions:
      - set:
          comeback_chance: 0
      - choice:
          key: final_comeback
          prompt: "재지목 기회(1회). 최종 범인은?"
          options:
            - text: "신이치"
              set:
                culprit_answer: "신이치"
                suspect: "신이치"
              add:
                truth_point: 1
                trust: 1
                final_confidence: 1
              goto: verdict_branch
            - text: "레이코"
              set:
                culprit_answer: "레이코"
                suspect: "레이코"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "켄지"
              set:
                culprit_answer: "켄지"
                suspect: "켄지"
              add:
                mistake_count: 1
              goto: bad_epilogue

  verdict_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "신이치"
                  - var: truth_point
                    op: gte
                    value: 9
                  - var: mistake_count
                    op: lte
                    value: 2
                  - var: trust
                    op: gte
                    value: 2
                  - var: final_confidence
                    op: gte
                    value: 6
                  - var: clue_word
                    op: in
                    value:
                      - "금속"
                      - "금속 냄새"
                      - "쇠"
                      - "쇠 냄새"
              goto: true_epilogue
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "신이치"
                  - var: truth_point
                    op: gte
                    value: 6
                  - var: final_confidence
                    op: gte
                    value: 3
                  - var: mistake_count
                    op: lte
                    value: 5
              goto: normal_epilogue
          default: bad_epilogue

  true_epilogue:
    actions:
      - bg: mountain_rain
      - music: rain
      - effect: zoom
      - say:
          char: 코난.serious
          text: "주전자 뚜껑 안쪽의 독, 그리고 왼쪽 손잡이 잔 순서. 답은 하나였어."
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "...맞아. 연구를 빼앗긴 날부터, 난 이미 선을 넘고 있었지."
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "차 한 잔의 습관이... 결국 진실을 드러냈네."
      - ending: true_end

  normal_epilogue:
    actions:
      - bg: mountain_rain
      - music: rain
      - effect: blur
      - say:
          char: 코난.think
          text: "범인은 맞췄다. 하지만 몇 번의 오판이 진실의 속도를 늦췄어."
      - say:
          char: 코고로.angry
          with:
            - 코난.think
          text: "크흠... 뭐, 결론은 내 이름으로 잘 정리됐으니 된 거지!"
      - ending: normal_end

  bad_epilogue:
    actions:
      - bg: mountain_rain
      - music: tension
      - sound: thunder
      - effect: shake
      - say:
          char: 코난.think
          text: "단서를 놓쳤다... 이 상태로는 누구도 완전히 납득시키지 못해."
      - say:
          text: "폭우가 그친 뒤에도, 다실의 비밀은 흐린 채 남았다."
      - ending: bad_end
