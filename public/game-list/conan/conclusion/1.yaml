script:
  - scene: final_intro
  - scene: sleeping_kogoro
  - scene: reasoning_tone_branch
  - scene: sharp_reasoning
  - scene: cautious_reasoning
  - scene: coverage_branch
  - scene: full_coverage_line
  - scene: partial_coverage_line
  - scene: early_exit_line
  - scene: final_accuse_gate
  - scene: accuse_confirm_reiko
  - scene: accuse_confirm_other
  - scene: wrong_answer_check
  - scene: comeback_gate
  - scene: verdict_branch
  - scene: true_epilogue
  - scene: normal_epilogue
  - scene: bad_epilogue

scenes:
  final_intro:
    actions:
      - bg: case_board
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "좋아, 전부 모였다. 흩어진 단서를 한 줄의 진실로 세운다."
      - wait: 340
      - say:
          char: 코난.think
          text: "(뚜껑 두 번은 눈속임... 핵심은 잔 가장자리 반응과 문서 수정 시간이다.)"
      - goto: sleeping_kogoro

  sleeping_kogoro:
    actions:
      - bg: ryokan_hall
      - char:
          id: 코고로
          position: left
          emotion: proud
      - char:
          id: 코난
          position: center
          emotion: think
      - effect: flash
      - sound: door
      - say:
          char: 코난.think
          with:
            - 코고로.angry
          text: "(아저씨, 잠깐만 실례할게... 범인을 멈추려면 지금이야.)"
      - say:
          text: "퓻-! 아주 짧은 소리와 함께 침이 날아가고, 코고로가 천천히 의자에 기대어 눈을 감는다."
      - say:
          text: "챙-! 코난의 머릿속에서 마지막 조각이 정확히 맞물린다."
      - add:
          final_confidence: 1
      - goto: reasoning_tone_branch

  reasoning_tone_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: final_confidence
                    op: gte
                    value: 5
                  - var: trust
                    op: gte
                    value: 2
              goto: sharp_reasoning
          default: cautious_reasoning

  sharp_reasoning:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "이건 단순한 사고가 아니야. 독은 찻물에 바로 들어간 게 아니라, 찻잔 가장자리에서 먼저 반응했다."
      - say:
          char: 코난.serious
          text: "주전자 뚜껑을 두 번 누른 동작은 우리 시선을 빼앗기 위한 연막이었다."
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "즉, 누군가가 잔 순서를 의도적으로 '보여 준' 셈이군요."
      - goto: coverage_branch

  cautious_reasoning:
    actions:
      - effect: darken
      - say:
          char: 코난.think
          text: "핵심은 같다. 잔 가장자리 반응과 뚜껑 두 번, 두 단서를 한 묶음으로 봐야 해."
      - say:
          char: 란.worried
          with:
            - 코난.think
          text: "그럼 범인은 반응 시점과 잔 순서를 둘 다 아는 사람이네..."
      - goto: coverage_branch

  coverage_branch:
    actions:
      - branch:
          cases:
            - when:
                var: investigation_count
                op: gte
                value: 4
              goto: full_coverage_line
          default: partial_coverage_line

  full_coverage_line:
    actions:
      - say:
          char: 코난.serious
          text: "네 명 모두 확인 끝. 이제 빈틈 없이 밀어붙일 수 있어."
      - goto: final_accuse_gate

  partial_coverage_line:
    actions:
      - say:
          char: 코난.think
          text: "(아직 못 건드린 대면이 있어... 마지막 선택은 더 조심해야 한다.)"
      - branch:
          cases:
            - when:
                var: early_exit_taken
                op: eq
                value: true
              goto: early_exit_line
          default: final_accuse_gate

  early_exit_line:
    actions:
      - say:
          char: 코난.think
          text: "중간에 끊고 온 대가는 있지만... 지금 가진 증거로 끝까지 간다."
      - goto: final_accuse_gate

  final_accuse_gate:
    actions:
      - bg: tea_room
      - music: reasoning
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "이제 지목한다. 범인은 이 안에 있어. 다들 잘 들어."
      - choice:
          key: final_accuse
          prompt: "모든 단서를 맞춰 봤을 때, 범인은 누구지?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                final_confidence: 1
              goto: accuse_confirm_reiko
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              add:
                mistake_count: 1
                trust: -1
              goto: accuse_confirm_other
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              add:
                mistake_count: 1
                trust: -1
              goto: accuse_confirm_other
            - text: "하루오"
              set:
                culprit_answer: "하루오"
              add:
                mistake_count: 1
                trust: -1
              goto: accuse_confirm_other

  accuse_confirm_reiko:
    actions:
      - say:
          char: 코난.serious
          with:
            - 레이코.nervous
          text: "좋아, 레이코로 못 박는다. 이 지목을 지금 확정할까?"
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "...정말, 제가 범인이라고 생각해요?"
      - choice:
          key: final_accuse_confirm_reiko
          prompt: "레이코 지목을 확정할까?"
          options:
            - text: "확정한다"
              goto: verdict_branch
            - text: "잠깐, 다시 생각한다"
              add:
                final_confidence: -1
              goto: final_accuse_gate

  accuse_confirm_other:
    actions:
      - say:
          char: 코난.think
          text: "좋아, 그 이름으로 가겠다는 거지. 끝까지 버틸 근거가 있나?"
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "지금 확정하면 되돌리기 어렵습니다."
      - choice:
          key: final_accuse_confirm_other
          prompt: "이 지목을 어떻게 할까?"
          options:
            - text: "틀렸다. 다시 지목한다"
              add:
                final_confidence: -1
              goto: final_accuse_gate
            - text: "아냐, 이 지목으로 밀어붙인다"
              goto: wrong_answer_check

  wrong_answer_check:
    actions:
      - say:
          char: 코난.think
          text: "(아직 끝난 게 아냐... 한 번, 단 한 번 바로잡을 기회가 있다.)"
      - branch:
          cases:
            - when:
                all:
                  - var: comeback_chance
                    op: gte
                    value: 1
                  - var: deduction_score
                    op: gte
                    value: 5
                  - var: mistake_count
                    op: lte
                    value: 4
              goto: comeback_gate
          default: bad_epilogue

  comeback_gate:
    actions:
      - set:
          comeback_chance: 0
      - say:
          char: 코난.serious
          text: "마지막 재지목이다. 이번에 빗나가면 끝이야."
      - choice:
          key: final_comeback
          prompt: "재지목 기회(1회). 최종 범인은?"
          options:
            - text: "레이코"
              set:
                culprit_answer: "레이코"
              add:
                deduction_score: 1
                trust: 1
                final_confidence: 1
              goto: verdict_branch
            - text: "신이치"
              set:
                culprit_answer: "신이치"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "켄지"
              set:
                culprit_answer: "켄지"
              add:
                mistake_count: 1
              goto: bad_epilogue
            - text: "하루오"
              set:
                culprit_answer: "하루오"
              add:
                mistake_count: 1
              goto: bad_epilogue

  verdict_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: deduction_score
                    op: gte
                    value: 10
                  - var: mistake_count
                    op: lte
                    value: 2
                  - var: trust
                    op: gte
                    value: 2
                  - var: final_confidence
                    op: gte
                    value: 6
                  - var: clue_rim_reagent
                    op: eq
                    value: true
                  - var: clue_haruo_wipe
                    op: eq
                    value: true
                  - var: clue_order_note
                    op: eq
                    value: true
                  - var: reiko_motive_open
                    op: eq
                    value: true
              goto: true_epilogue
            - when:
                all:
                  - var: culprit_answer
                    op: eq
                    value: "레이코"
                  - var: deduction_score
                    op: gte
                    value: 6
                  - var: final_confidence
                    op: gte
                    value: 3
                  - var: mistake_count
                    op: lte
                    value: 5
              goto: normal_epilogue
          default: bad_epilogue

  true_epilogue:
    actions:
      - bg: mountain_rain
      - music: solvethecase
      - effect: zoom
      - say:
          char: 코난.serious
          text: "잔 가장자리 반응, 잔 순서 메모, 닦는 동작, 계약서 수정 시각... 모든 단서가 레이코를 가리켰어."
      - music: confession
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "...연구를 빼앗긴다고 믿는 순간, 저는 선을 넘어버렸어요."
      - music: solvethecase
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "사소해 보였던 습관 하나가... 결국 진실을 열었네."
      - ending: true_end

  normal_epilogue:
    actions:
      - bg: mountain_rain
      - music: reasoning
      - effect: blur
      - say:
          char: 코난.think
          text: "(범인은 맞췄지만 빈칸이 남았어... 진실이 완전히 잠기진 않았다.)"
      - say:
          char: 코고로.angry
          with:
            - 코난.think
          text: "크흠! 그래도 여기까지 끌고 온 건 충분히 잘한 거다!"
      - ending: normal_end

  bad_epilogue:
    actions:
      - bg: mountain_rain
      - music: reasoning
      - sound: thunder
      - effect: shake
      - say:
          char: 코난.think
          text: "(단서 연결이 끊겼어... 지금 상태론 누구도 끝까지 납득 못 해.)"
      - ending: bad_end
