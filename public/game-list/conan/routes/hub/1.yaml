script:
  - scene: lounge_intro
  - scene: all_done_check
  - scene: all_done_bonus
  - scene: route_select
  - scene: early_exit_confirm
  - scene: early_exit_penalty_branch
  - scene: early_exit_penalty_3
  - scene: early_exit_penalty_2
  - scene: early_exit_penalty_1
  - scene: move_to_conclusion_gate
  - scene: move_to_conclusion_ready
  - scene: move_to_conclusion_blocked

scenes:
  lounge_intro:
    actions:
      - bg: ryokan_hall
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "<speed=30>(시간은 짧다.)</speed> <speed=60>남은 건 사람과 거짓말을 분리하는 일.</speed>"
      - goto: all_done_check

  all_done_check:
    actions:
      - branch:
          cases:
            - when:
                var: investigation_count
                op: gte
                value: 4
              goto: all_done_bonus
          default: route_select

  all_done_bonus:
    actions:
      - set:
          early_exit_taken: false
      - add:
          deduction_score: 1
          final_confidence: 1
          trust: 1
      - say:
          char: 코난.serious
          text: "<speed=56>좋아, 네 라인 전부 확인 완료.</speed> <speed=34>이제 집합 추리로 끝낸다.</speed>"
      - goto: move_to_conclusion_gate

  route_select:
    actions:
      - say:
          char: 코난.think
          text: "<speed=34>다음 타깃을 고르자.</speed> <speed=58>누구부터 균열이 날까?</speed>"
      - choice:
          key: route_select
          prompt: "다음으로 어디를 조사할까?"
          options:
            - text: "신이치를 대면한다"
              goto: /routes/shinichi/1.yaml
            - text: "레이코를 압박한다"
              goto: /routes/reiko/1.yaml
            - text: "켄지 동선을 검증한다"
              goto: /routes/kenji/1.yaml
            - text: "하루오의 유품/다잉메시지를 조사한다"
              goto: /routes/haruo/1.yaml
            - text: "지금 정리 회의로 간다"
              goto: early_exit_confirm

  early_exit_confirm:
    actions:
      - say:
          char: 코난.think
          text: "<speed=30>지금 결론으로 가면 반박에 취약해진다.</speed> <speed=62>그래도 밀어붙일까?</speed>"
      - choice:
          key: early_exit_confirm
          prompt: "지금 바로 정리 회의로 넘어갈까?"
          options:
            - text: "아직 더 확인한다"
              goto: route_select
            - text: "여기서 바로 간다"
              set:
                early_exit_taken: true
              goto: early_exit_penalty_branch

  early_exit_penalty_branch:
    actions:
      - branch:
          cases:
            - when:
                var: investigation_count
                op: gte
                value: 3
              goto: early_exit_penalty_3
            - when:
                var: investigation_count
                op: gte
                value: 2
              goto: early_exit_penalty_2
          default: early_exit_penalty_1

  early_exit_penalty_3:
    actions:
      - add:
          final_confidence: -1
      - say:
          char: 코난.think
          text: "<speed=30>한 라인을 비우고 간다.</speed> <speed=54>설득력은 한 단계 낮아진다.</speed>"
      - goto: move_to_conclusion_gate

  early_exit_penalty_2:
    actions:
      - add:
          deduction_score: -1
          final_confidence: -2
      - say:
          char: 코난.think
          text: "<speed=28>절반만 확인한 결론은 약해.</speed> <speed=60>반격 한 번에 무너질 수 있어.</speed>"
      - goto: move_to_conclusion_gate

  early_exit_penalty_1:
    actions:
      - add:
          deduction_score: -2
          final_confidence: -3
          trust: -1
          mistake_count: 1
      - say:
          char: 코난.think
          text: "<speed=24>(너무 빨랐어...)</speed> <speed=58>지금 상태론 진실보다 추측이 많다.</speed>"
      - goto: move_to_conclusion_gate

  move_to_conclusion_gate:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: tea_residue_report
                    op: eq
                    value: true
                  - var: reiko_statement_note
                    op: eq
                    value: true
              goto: move_to_conclusion_ready
          default: move_to_conclusion_blocked

  move_to_conclusion_ready:
    actions:
      - say:
          char: 코난
          text: "<speed=50>전원 집합.</speed> <speed=34>이제 마지막 줄을 완성한다.</speed>"
      - goto: /conclusion/1.yaml

  move_to_conclusion_blocked:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>아직 못 간다.</speed> <speed=34>가방에 '찻잔 반응 시료 카드'와 '레이코 진술 메모'가 모두 있어야 집합 추리를 열 수 있어.</speed>"
      - goto: route_select
