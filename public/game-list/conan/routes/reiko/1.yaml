script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: intro_item_get
  - scene: intro_item_already_owned
  - scene: first_probe
  - scene: first_claim_correct
  - scene: first_claim_wrong
  - scene: retry_notice
  - scene: second_probe
  - scene: second_claim_correct
  - scene: second_claim_wrong
  - scene: motive_branch
  - scene: motive_open_line
  - scene: motive_half_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_reiko
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: ryokan_hall
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 레이코.nervous
          with:
            - 코난.think
          text: "<speed=30>같은 질문은...</speed> <speed=24>더 떨리게만 해요.</speed>"
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: reasoning
      - set:
          visited_reiko: true
      - add:
          investigation_count: 1
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=30>88도 근처에서 향 반응이 바뀌어야 해요.</speed> <speed=24>근데 오늘은 타이밍이 틀어졌어요.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=52>좋아.</speed> <speed=34>감정은 빼고 수치만 남긴다.</speed>"
      - branch:
          cases:
            - when:
                var: reiko_statement_note
                op: eq
                value: true
              goto: intro_item_already_owned
          default: intro_item_get

  intro_item_get:
    actions:
      - get: reiko_statement_note
      - sticker:
          id: item_popup_reiko_statement_note
          image: item_reiko_statement_note
          x: 50
          y: 30
          width: 22
          enter:
            effect: popIn
          inputLockMs: 500
      - say:
          char: 코난.think
          text: "<speed=34>레이코 진술 메모를 획득했다.</speed> <speed=56>이제 흔들리는 문장만 추려내자.</speed>"
      - clearSticker:
          id: item_popup_reiko_statement_note
          leave:
            effect: fadeOut
      - goto: first_probe

  intro_item_already_owned:
    actions:
      - say:
          char: 코난.think
          text: "<speed=30>레이코 진술 메모는 이미 확보했다.</speed> <speed=56>중복 진술 대신 다음 판단으로 간다.</speed>"
      - goto: first_probe

  first_probe:
    actions:
      - say:
          char: 코난.serious
          with:
            - 레이코.nervous
          text: "<speed=36>지금 증명 가능한 문장 하나만 고르자.</speed>"
      - choice:
          key: reiko_first_probe
          prompt: "레이코 진술에서 먼저 고정할 것은?"
          options:
            - text: "88도 기록과 잔 가장자리 반응 시간을 맞춘다"
              set:
                clue_rim_reagent: true
              add:
                deduction_score: 2
              goto: first_claim_correct
            - text: "떨리는 말투를 범행 신호로 본다"
              add:
                mistake_count: 1
                trust: -1
              goto: first_claim_wrong
            - text: "켄지와 다툰 사실만으로 묶는다"
              add:
                mistake_count: 1
              goto: first_claim_wrong

  first_claim_correct:
    actions:
      - say:
          char: 코난.serious
          with:
            - 레이코.nervous
          text: "<speed=56>좋아, 그건 물증화 가능하다.</speed> <speed=34>주력 증거로 쓸까?</speed>"
      - choice:
          key: reiko_first_commit
          prompt: "1차 주장을 확정할까?"
          options:
            - text: "확정"
              goto: motive_branch
            - text: "한 번 더 확인"
              goto: retry_notice

  first_claim_wrong:
    actions:
      - say:
          char: 코난.think
          with:
            - 레이코.nervous
          text: "<speed=28>지금 고른 건 분위기야.</speed> <speed=60>논리전에선 바로 무너진다.</speed>"
      - choice:
          key: reiko_first_rebuttal
          prompt: "이 판단을 어떻게 처리할까?"
          options:
            - text: "틀렸다. 다시 질문"
              goto: retry_notice
            - text: "아직 이 해석으로 민다"
              add:
                mistake_count: 1
                trust: -1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>(재심문이다.)</speed> <speed=60>감정선 버리고 측정값만 본다.</speed>"
      - goto: second_probe

  second_probe:
    actions:
      - choice:
          key: reiko_second_probe
          prompt: "재선택: 지금 바로 입증 가능한 것은?"
          options:
            - text: "88도 기록과 잔 가장자리 반응 시간을 맞춘다"
              set:
                clue_rim_reagent: true
              add:
                deduction_score: 1
              goto: second_claim_correct
            - text: "말투 흔들림만으로 결론 낸다"
              add:
                mistake_count: 1
                trust: -1
              goto: second_claim_wrong
            - text: "분위기만 보고 확정한다"
              add:
                mistake_count: 1
              goto: second_claim_wrong

  second_claim_correct:
    actions:
      - say:
          text: "<speed=70>챙-!</speed> <speed=38>온도 기록과 반응 시간이 겹친다.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=56>좋아, 수치가 맞아떨어졌다.</speed> <speed=34>최종 채택?</speed>"
      - choice:
          key: reiko_second_commit
          prompt: "최종 채택할까?"
          options:
            - text: "채택"
              goto: motive_branch
            - text: "보류"
              add:
                final_confidence: -1
              goto: motive_half_line

  second_claim_wrong:
    actions:
      - say:
          char: 코난.think
          with:
            - 레이코.nervous
          text: "<speed=28>아직 감정선이야.</speed> <speed=60>이대로는 동기 라인이 안 열린다.</speed>"
      - choice:
          key: reiko_second_rebuttal
          prompt: "지금 선택은?"
          options:
            - text: "접고 돌아간다"
              goto: motive_half_line
            - text: "끝까지 우긴다"
              add:
                trust: -1
              goto: motive_half_line

  motive_branch:
    actions:
      - branch:
          cases:
            - when:
                var: clue_rim_reagent
                op: eq
                value: true
              goto: motive_open_line
          default: motive_half_line

  motive_open_line:
    actions:
      - sound: notebook_flip
      - effect: zoom
      - say:
          char: 코난.serious
          text: "<speed=40>계약서 수정 시각, 연구노트 원본 시각, 그리고 2번 컵 반응.</speed> <speed=64>셋이 정확히 맞물린다.</speed>"
      - say:
          char: 레이코.nervous
          with:
            - 코난.serious
          text: "<speed=26>...거기까지 연결하셨군요.</speed>"
      - set:
          reiko_motive_open: true
      - add:
          deduction_score: 2
          final_confidence: 1
          trust: 1
      - goto: outro

  motive_half_line:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(레이코 라인은 반쯤 열렸다.)</speed> <speed=58>결론에선 보조 증거로만 쓴다.</speed>"
      - add:
          mistake_count: 1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>레이코 라인 종료.</speed> <speed=34>라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
