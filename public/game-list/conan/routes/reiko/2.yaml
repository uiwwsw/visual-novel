script:
  - scene: pressure_intro
  - scene: cross_check_gate
  - scene: detour_loop
  - scene: decisive_input
  - scene: proof_lock_branch
  - scene: lock_success
  - scene: lock_fragile
  - scene: route_outro

scenes:
  pressure_intro:
    actions:
      - bg: mountain_rain
      - music: tension
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 코고로
          position: right
          emotion: angry
      - say:
          text: "레이코 루트 2 - 역추적 마무리"
      - say:
          char: 코고로.angry
          with:
            - 코난.serious
          text: "으음... 다들 수상해 보여서 더 헷갈린단 말이지!"
      - say:
          char: 코난.think
          with:
            - 코고로.angry
          text: "(아저씨 말투는 시끄럽지만, 지금 필요한 건 정확한 순서야.)"

  cross_check_gate:
    actions:
      - bg: tea_room
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - choice:
          key: reiko_cross_check
          prompt: "교차 검증의 중심을 선택"
          options:
            - text: "찻잎 성분표와 젖은 소매 모순을 연결한다"
              set:
                suspect: "신이치"
              add:
                truth_point: 2
                trust: 1
              goto: decisive_input
            - text: "초기 인상대로 레이코를 고정한다"
              set:
                suspect: "레이코"
              add:
                mistake_count: 1
              goto: detour_loop

  detour_loop:
    actions:
      - effect: pulse
      - say:
          char: 코난.think
          text: "지금은 강행하면 안 돼. 한 번만 더 교정할 기회가 있어."
      - choice:
          key: reiko_detour
          prompt: "우회 분기 처리"
          options:
            - text: "교차 검증으로 돌아간다"
              add:
                trust: 1
              goto: cross_check_gate
            - text: "패널티를 감수하고 결론으로 밀어붙인다"
              add:
                mistake_count: 1
              goto: decisive_input

  decisive_input:
    actions:
      - input:
          prompt: "레이코가 최종 진술에서 남긴 향 표현은?"
          correct: "금속 냄새"
          saveAs: clue_word
          errors:
            - "찻잎 고유 향이 아니야."
            - "힌트: 쇠붙이처럼 차가운 냄새."
            - "정답은 금속 냄새."
          routes:
            - equals: "금속 냄새"
              set:
                suspect: "신이치"
                metal_smell_flag: true
              add:
                truth_point: 2
                final_confidence: 1
              goto: proof_lock_branch
            - equals: "찻잎 향"
              add:
                mistake_count: 1
              goto: proof_lock_branch
            - equals: "연기 냄새"
              add:
                mistake_count: 1
              goto: proof_lock_branch

  proof_lock_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: suspect
                    op: eq
                    value: "신이치"
                  - var: truth_point
                    op: gte
                    value: 6
                  - var: mistake_count
                    op: lte
                    value: 3
              goto: lock_success
          default: lock_fragile

  lock_success:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "좋아. 증거 사슬이 끊기지 않는다. 결론 회의에서 바로 닫는다."
      - add:
          final_confidence: 2
      - goto: route_outro

  lock_fragile:
    actions:
      - effect: blur
      - say:
          char: 코난.think
          text: "범인상은 잡혔지만, 결론선이 아직 흔들린다."
      - choice:
          key: reiko_fragile_patch
          prompt: "마지막 보정 선택"
          options:
            - text: "주전자 각도 재현을 다시 강조한다"
              add:
                truth_point: 1
                final_confidence: 1
            - text: "동기 압박만 강화한다"
              add:
                mistake_count: 1
      - goto: route_outro

  route_outro:
    actions:
      - say:
          char: 코난
          text: "결론 회의로 이동한다. 마지막 한 수만 남았다."
      - goto: /conclusion/1.yaml
