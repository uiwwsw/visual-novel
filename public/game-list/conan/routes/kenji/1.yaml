script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_probe
  - scene: first_claim_correct
  - scene: first_claim_wrong
  - scene: retry_notice
  - scene: second_probe
  - scene: second_claim_correct
  - scene: second_claim_wrong
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_kenji
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "동선은 이미 다 말했다고. 같은 질문이면 진술만 꼬여."
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: reasoning
      - set:
          visited_kenji: true
      - add:
          investigation_count: 1
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코고로
          position: right
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 켄지.angry
          with:
            - 코난.serious
          text: "목소리 높인 건 인정해! 하지만 찻상 근처엔 가지도 않았어!"
      - say:
          char: 코난.serious
          text: "좋아, 감정은 빼고 이동 기록만 남긴다."

  first_probe:
    actions:
      - say:
          char: 코난.serious
          with:
            - 켄지.angry
          text: "사건 직전, 네 발이 어디에 있었는지 그 한 줄만 답해."
      - choice:
          key: kenji_first_probe
          prompt: "사건 직전 켄지 동선에서 핵심은?"
          options:
            - text: "복도에서 통화 중이라 다실 출입선에서 떨어져 있었다"
              add:
                deduction_score: 1
              goto: first_claim_correct
            - text: "말다툼했으니 바로 실행했을 거다"
              add:
                mistake_count: 1
                trust: -1
              goto: first_claim_wrong
            - text: "목소리가 컸으니 오히려 침착했을 거다"
              add:
                mistake_count: 1
              goto: first_claim_wrong

  first_claim_correct:
    actions:
      - say:
          char: 코난.serious
          with:
            - 켄지.angry
          text: "좋아, 그 진술은 기록으로 받쳐진다. 채택하고 다음으로 갈까?"
      - choice:
          key: kenji_first_commit
          prompt: "1차 동선을 확정할까?"
          options:
            - text: "확정한다"
              goto: second_probe
            - text: "아직 불안하다. 다시 묻는다"
              goto: retry_notice

  first_claim_wrong:
    actions:
      - say:
          char: 코난.think
          with:
            - 켄지.angry
          text: "그건 성격 추측일 뿐 동선이 아니야. 그 논리로는 못 버텨."
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "좋아, 동선으로만 따져. 그건 인정하지."
      - choice:
          key: kenji_first_rebuttal
          prompt: "이 판단을 어떻게 할까?"
          options:
            - text: "틀렸다. 다시 질문"
              goto: retry_notice
            - text: "아냐, 이걸로도 밀어본다"
              add:
                mistake_count: 1
                trust: -1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "(좋아, 다시 간다. 성격이 아니라 이동 기록만 본다.)"
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "그건 자신 있어. 기록대로 말했어."
      - goto: second_probe

  second_probe:
    actions:
      - choice:
          key: kenji_second_probe
          prompt: "재현으로 확인된 사실은?"
          options:
            - text: "뚜껑 두 번 누름은 시선을 돌리는 미끼였다"
              set:
                clue_double_press_decoy: true
              add:
                deduction_score: 2
                final_confidence: 1
                trust: 1
              goto: second_claim_correct
            - text: "분노가 크면 물증 없어도 확정 가능하다"
              add:
                mistake_count: 1
              goto: second_claim_wrong
            - text: "통화 기록보다 직감이 정확하다"
              add:
                mistake_count: 1
                trust: -1
              goto: second_claim_wrong

  second_claim_correct:
    actions:
      - say:
          text: "챙-! 흐릿하던 동선이 한 번에 맞물린다."
      - say:
          char: 코난.serious
          with:
            - 켄지.angry
          text: "좋아, 이 해석엔 물증이 붙는다. 최종 결론으로 둘까?"
      - choice:
          key: kenji_second_commit
          prompt: "최종 채택할까?"
          options:
            - text: "채택한다"
              goto: success_line
            - text: "보류한다"
              add:
                final_confidence: -1
              goto: fail_line

  second_claim_wrong:
    actions:
      - say:
          char: 코난.think
          with:
            - 켄지.angry
          text: "그 선택은 감정선이다. 이대로 밀면 결론이 깨진다."
      - choice:
          key: kenji_second_rebuttal
          prompt: "지금 선택은?"
          options:
            - text: "틀렸다 인정하고 접는다"
              goto: fail_line
            - text: "끝까지 민다"
              add:
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - say:
          char: 코난.serious
          text: "좋아, 켄지 라인 정리 완료. 분노와 실행은 별개라는 게 확정됐어."
      - say:
          char: 켄지.angry
          with:
            - 코난.serious
          text: "이제야 말이 통하네."
      - goto: outro

  fail_line:
    actions:
      - say:
          char: 코난.think
          text: "(켄지 라인은 아직 거칠어... 이대로 닫으면 결론이 흔들린다.)"
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "켄지 대면 끝. 라운지로 복귀한다."
      - goto: /routes/hub/1.yaml
