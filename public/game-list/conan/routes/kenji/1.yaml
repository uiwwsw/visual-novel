script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_probe
  - scene: first_claim_correct
  - scene: first_claim_wrong
  - scene: retry_notice
  - scene: second_probe
  - scene: second_claim_correct
  - scene: second_claim_wrong
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_kenji
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "<speed=32>동선은 다 말했다고.</speed> <speed=26>중복 질문이면 진술만 꼬여.</speed>"
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: reasoning
      - set:
          visited_kenji: true
      - add:
          investigation_count: 1
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 코고로
          position: right
          emotion: angry
      - say:
          char: 켄지.angry
          with:
            - 코난.serious
          text: "<speed=54>큰소리 친 건 인정한다!</speed> <speed=30>하지만 난 2번 잔 근처에도 안 갔어!</speed>"
      - say:
          char: 코난.serious
          with:
            - 켄지.angry
          text: "<speed=40>좋아.</speed> <speed=30>분노는 빼고, 발자국과 통화기록으로만 말하자.</speed>"

  first_probe:
    actions:
      - say:
          char: 코난.serious
          with:
            - 켄지.angry
          text: "<speed=34>사건 직전 네 위치를 한 줄로 말해.</speed>"
      - choice:
          key: kenji_first_probe
          prompt: "켄지 동선에서 핵심은?"
          options:
            - text: "복도 통화 중이라 다실 출입선에서 떨어져 있었다"
              add:
                deduction_score: 1
              goto: first_claim_correct
            - text: "화가 났으니 즉시 범행했을 것이다"
              add:
                mistake_count: 1
                trust: -1
              goto: first_claim_wrong
            - text: "목소리가 컸으니 오히려 침착했을 것이다"
              add:
                mistake_count: 1
              goto: first_claim_wrong

  first_claim_correct:
    actions:
      - say:
          char: 코난.serious
          with:
            - 켄지.angry
          text: "<speed=54>좋아, 그 동선은 기록과 일치한다.</speed> <speed=34>확정할까?</speed>"
      - choice:
          key: kenji_first_commit
          prompt: "1차 동선을 확정할까?"
          options:
            - text: "확정"
              goto: second_probe
            - text: "다시 묻는다"
              goto: retry_notice

  first_claim_wrong:
    actions:
      - say:
          char: 코난.think
          with:
            - 켄지.angry
          text: "<speed=28>그건 성격 추측이야.</speed> <speed=58>동선 증거가 아니다.</speed>"
      - choice:
          key: kenji_first_rebuttal
          prompt: "이 판단을 어떻게 할까?"
          options:
            - text: "틀렸다. 재질문"
              goto: retry_notice
            - text: "아직 이 논리로 민다"
              add:
                mistake_count: 1
                trust: -1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>(좋아, 다시.)</speed> <speed=58>감정 아닌 이동 기록으로 좁힌다.</speed>"
      - goto: second_probe

  second_probe:
    actions:
      - choice:
          key: kenji_second_probe
          prompt: "재구성으로 확인된 사실은?"
          options:
            - text: "뚜껑 두 번은 시선을 돌리는 연막이었다"
              set:
                clue_double_press_decoy: true
              add:
                deduction_score: 2
                final_confidence: 1
                trust: 1
              goto: second_claim_correct
            - text: "분노가 크면 물증 없이도 확정 가능하다"
              add:
                mistake_count: 1
              goto: second_claim_wrong
            - text: "통화 기록보다 직감이 정확하다"
              add:
                mistake_count: 1
                trust: -1
              goto: second_claim_wrong

  second_claim_correct:
    actions:
      - say:
          text: "<speed=70>챙-!</speed> <speed=40>연막과 진짜 동선이 분리된다.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=56>좋아, 켄지 라인은 범행 실행에서 빠진다.</speed> <speed=34>채택.</speed>"
      - choice:
          key: kenji_second_commit
          prompt: "최종 채택할까?"
          options:
            - text: "채택"
              goto: success_line
            - text: "보류"
              add:
                final_confidence: -1
              goto: fail_line

  second_claim_wrong:
    actions:
      - say:
          char: 코난.think
          with:
            - 켄지.angry
          text: "<speed=28>그 선택은 감정선이야.</speed> <speed=58>결론에서 바로 깨진다.</speed>"
      - choice:
          key: kenji_second_rebuttal
          prompt: "지금 선택은?"
          options:
            - text: "틀렸다 인정"
              goto: fail_line
            - text: "끝까지 민다"
              add:
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=50>좋아, 켄지 라인 정리 완료.</speed> <speed=34>분노와 실행은 분리됐다.</speed>"
      - goto: outro

  fail_line:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(켄지 라인은 아직 거칠다...)</speed> <speed=58>보강 없인 위험해.</speed>"
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>켄지 라인 종료.</speed> <speed=34>라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
