script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_probe
  - scene: retry_notice
  - scene: second_probe
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_kenji
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "동선은 이미 다 얘기했어. 같은 질문이면 다시 꼬이기만 해."
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: tension
      - set:
          visited_kenji: true
      - add:
          investigation_count: 1
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코고로
          position: right
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 켄지.angry
          with:
            - 코난.serious
          text: "소리 질렀던 건 인정해. 근데 찻상 근처엔 못 갔어!"
      - say:
          char: 코난.serious
          text: "좋아. 감정과 실행 가능성을 분리해서 재현해 보자."

  first_probe:
    actions:
      - choice:
          key: kenji_first_probe
          prompt: "사건 직전 켄지의 동선에서 핵심은?"
          options:
            - text: "복도 전화 통화로 다실 출입선에서 벗어나 있었다"
              add:
                deduction_score: 1
              goto: second_probe
            - text: "말다툼이 있었으니 바로 실행했을 것이다"
              add:
                mistake_count: 1
                trust: -1
              goto: retry_notice
            - text: "목소리가 컸으니 누구보다 침착했을 것이다"
              add:
                mistake_count: 1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "한 번만 더. 추측이 아니라 동선 기록으로 고르자."
      - goto: second_probe

  second_probe:
    actions:
      - choice:
          key: kenji_second_probe
          prompt: "재현에서 확인된 사실은?"
          options:
            - text: "뚜껑 두 번 누름은 시선 분산용 미끼였다"
              set:
                clue_double_press_decoy: true
              add:
                deduction_score: 2
                final_confidence: 1
                trust: 1
              goto: success_line
            - text: "분노가 강했으니 물증 없이도 확정 가능하다"
              add:
                mistake_count: 1
              goto: fail_line
            - text: "통화 기록보다 직감이 더 정확하다"
              add:
                mistake_count: 1
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - say:
          char: 코난.serious
          text: "좋아, 켄지 축은 정리됐다. 분노와 실행은 다른 문제였어."
      - goto: outro

  fail_line:
    actions:
      - say:
          char: 코난.think
          text: "켄지 축은 아직 거칠어. 결론에서 섣불리 닫으면 위험해."
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "켄지 대면 종료. 조사 라운지로 복귀한다."
      - goto: /routes/hub/1.yaml
