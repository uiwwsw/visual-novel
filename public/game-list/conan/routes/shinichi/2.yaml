script:
  - scene: pressure_intro
  - scene: statement_cross
  - scene: cross_fail_loop
  - scene: decisive_input
  - scene: pressure_branch
  - scene: direct_lock
  - scene: doubt_lock
  - scene: route_outro

scenes:
  pressure_intro:
    actions:
      - bg: mountain_rain
      - music: tension
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 신이치
          position: right
          emotion: cold
      - say:
          text: "신이치 루트 2 - 진술 붕괴"
      - say:
          char: 코난.serious
          with:
            - 신이치.cold
          text: "네 알리바이는 단어마다 모순이 있어. 이제 하나씩 닫아보자."

  statement_cross:
    actions:
      - bg: tea_room
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - choice:
          key: shinichi_cross
          prompt: "교차 검증의 첫 타점을 선택"
          options:
            - text: "찻잎 성분표와 외투 섬유를 대조한다"
              set:
                suspect: "신이치"
              add:
                truth_point: 2
                trust: 1
              goto: decisive_input
            - text: "레이코의 떨리는 말투만 근거로 삼는다"
              set:
                suspect: "레이코"
              add:
                mistake_count: 1
                trust: -1
              goto: cross_fail_loop

  cross_fail_loop:
    actions:
      - effect: shake
      - say:
          char: 코난.think
          text: "감정으로 밀면 반발만 커져. 증거로 다시 간다."
      - branch:
          cases:
            - when:
                var: mistake_count
                op: gte
                value: 4
              goto: decisive_input
          default: statement_cross

  decisive_input:
    actions:
      - input:
          prompt: "레이코의 최종 진술에서 남은 핵심 표현은?"
          correct: "금속 냄새"
          saveAs: clue_word
          errors:
            - "차 본연의 향이 아니라 이질적인 냄새야."
            - "힌트: 금속성."
            - "정답은 금속 냄새."
          routes:
            - equals: "금속 냄새"
              set:
                suspect: "신이치"
                metal_smell_flag: true
              add:
                truth_point: 2
                final_confidence: 1
                trust: 1
              goto: pressure_branch
            - equals: "찻잎 향"
              add:
                mistake_count: 1
              goto: pressure_branch
            - equals: "젖은 나무 냄새"
              add:
                mistake_count: 1
              goto: pressure_branch

  pressure_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: final_confidence
                    op: gte
                    value: 4
                  - var: trust
                    op: gte
                    value: 2
                  - var: mistake_count
                    op: lte
                    value: 2
              goto: direct_lock
          default: doubt_lock

  direct_lock:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "좋아, 이제 결론 회의에서 바로 끝낸다. 빠져나갈 구멍은 없어."
      - add:
          final_confidence: 2
      - goto: route_outro

  doubt_lock:
    actions:
      - effect: blur
      - say:
          char: 코난.think
          text: "범인상은 맞지만 설득력은 아직 불안정해. 결론에서 한 번 더 다듬어야 해."
      - add:
          final_confidence: 1
      - goto: route_outro

  route_outro:
    actions:
      - say:
          char: 코난
          text: "결론 회의로 간다. 이제, 트릭의 이름을 말할 시간이다."
      - goto: /conclusion/1.yaml
