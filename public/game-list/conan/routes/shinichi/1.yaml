script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_input
  - scene: first_hit_review
  - scene: first_miss_review
  - scene: retry_notice
  - scene: second_input
  - scene: second_hit_review
  - scene: second_miss_review
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_shinichi
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "같은 질문은 시간 낭비입니다. 다른 대상부터 확인하시죠."
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: reasoning
      - set:
          visited_shinichi: true
      - add:
          investigation_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 신이치
          position: right
          emotion: cold
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "기억은 감정보다 숫자가 정확합니다."
      - say:
          char: 코난.serious
          text: "좋아. 그 숫자, 지금 이 자리에서 검증한다."
      - say:
          char: 신이치.cold
          text: "피해자 잔은 2번이었습니다."

  first_input:
    actions:
      - input:
          prompt: "신이치가 말한 피해자 잔 번호는? (1~4)"
          correct: "2"
          errors:
            - "1~4 중 하나야. 신이치는 분명 숫자로 말했다."
            - "힌트: 두 번째 잔."
            - "정답은 2."
          routes:
            - equals: "2"
              set:
                clue_order_note: true
              add:
                deduction_score: 2
                final_confidence: 1
                trust: 1
              goto: first_hit_review
            - equals: "1"
              add:
                mistake_count: 1
              goto: first_miss_review
            - equals: "3"
              add:
                mistake_count: 1
              goto: first_miss_review
            - equals: "4"
              add:
                mistake_count: 1
              goto: first_miss_review

  first_hit_review:
    actions:
      - say:
          text: "챙-! 숫자 단서 하나가 용의 범위를 좁힌다."
      - say:
          char: 코난.serious
          with:
            - 신이치.cold
          text: "좋아, 2번으로 고정한다. 이 진술을 지금 못 박을까?"
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "숫자와 일치합니다. 다만 확정은 당신이 하시죠."
      - choice:
          key: shinichi_first_commit
          prompt: "1차 판단. 2번 진술을 확정할까?"
          options:
            - text: "그래, 2번으로 잠근다"
              goto: success_line
            - text: "잠깐, 한 번 더 확인한다"
              goto: retry_notice

  first_miss_review:
    actions:
      - say:
          char: 코난.think
          with:
            - 신이치.cold
          text: "방금 답은 숫자 흐름이 안 맞아. 이대로 밀어붙일 거야?"
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "틀린 숫자를 고집하면 시간만 잃습니다."
      - choice:
          key: shinichi_first_rebuttal
          prompt: "이 오답을 어떻게 처리할까?"
          options:
            - text: "틀렸다. 다시 묻는다"
              goto: retry_notice
            - text: "아직 맞다고 본다. 다시 검증한다"
              add:
                trust: -1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "(좋아, 다시 간다. 감으로 찍지 말고 숫자만 봐.)"
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "두 번째 질문이 마지막입니다."
      - goto: second_input

  second_input:
    actions:
      - input:
          prompt: "재확인: 피해자 잔 번호는? (1~4)"
          correct: "2"
          errors:
            - "마지막 확인이야. 숫자 하나만 떠올려."
            - "힌트는 그대로 2."
            - "정답은 2."
          routes:
            - equals: "2"
              set:
                clue_order_note: true
              add:
                deduction_score: 1
                trust: 1
              goto: second_hit_review
            - equals: "1"
              add:
                mistake_count: 1
                trust: -1
              goto: second_miss_review
            - equals: "3"
              add:
                mistake_count: 1
                trust: -1
              goto: second_miss_review
            - equals: "4"
              add:
                mistake_count: 1
                trust: -1
              goto: second_miss_review

  second_hit_review:
    actions:
      - say:
          char: 코난.serious
          with:
            - 신이치.cold
          text: "좋아, 다시 2번이다. 이걸 최종 확정한다. 맞지?"
      - choice:
          key: shinichi_second_commit
          prompt: "최종 확정할까?"
          options:
            - text: "확정한다"
              goto: success_line
            - text: "아직 흔들린다. 보류한다"
              add:
                final_confidence: -1
              goto: fail_line

  second_miss_review:
    actions:
      - say:
          char: 코난.think
          with:
            - 신이치.cold
          text: "또 빗나갔어. 이 숫자 해석은 더 못 버텨."
      - choice:
          key: shinichi_second_rebuttal
          prompt: "지금 선택은?"
          options:
            - text: "여기서 접고 돌아간다"
              goto: fail_line
            - text: "그래도 우긴다"
              add:
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - say:
          char: 코난.serious
          text: "좋아, 잔 순서가 잠겼다. 이 순서를 아는 사람만 범위에 남는다."
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "이제 숫자 밖의 거짓말만 걷어내면 됩니다."
      - goto: outro

  fail_line:
    actions:
      - say:
          char: 코난.think
          text: "(잔 순서가 아직 흐려... 이 상태론 반박 하나도 막기 어렵다.)"
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "신이치 대면 끝. 라운지로 돌아가자."
      - goto: /routes/hub/1.yaml
