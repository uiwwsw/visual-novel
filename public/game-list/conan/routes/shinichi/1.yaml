script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_input
  - scene: first_hit_review
  - scene: first_miss_review
  - scene: retry_notice
  - scene: second_input
  - scene: second_hit_review
  - scene: second_miss_review
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_shinichi
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "<speed=34>같은 질문은 의미 없습니다.</speed> <speed=58>다른 라인을 보시죠.</speed>"
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: reasoning
      - set:
          visited_shinichi: true
      - add:
          investigation_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 신이치
          position: right
          emotion: cold
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "<speed=34>저는 순서표를 작성했을 뿐입니다.</speed> <speed=28>피해자 컵 번호는 2번.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=54>좋아.</speed> <speed=34>숫자는 거짓말을 덜 한다.</speed>"

  first_input:
    actions:
      - input:
          prompt: "신이치 기록 기준, 피해자 컵 번호는? (1~4)"
          correct: "2"
          errors:
            - "1~4 중 하나야. 신이치는 분명 숫자를 말했다."
            - "힌트: 두 번째 잔."
            - "정답은 2."
          routes:
            - equals: "2"
              set:
                clue_order_note: true
              add:
                deduction_score: 2
                final_confidence: 1
                trust: 1
              goto: first_hit_review
            - equals: "1"
              add:
                mistake_count: 1
              goto: first_miss_review
            - equals: "3"
              add:
                mistake_count: 1
              goto: first_miss_review
            - equals: "4"
              add:
                mistake_count: 1
              goto: first_miss_review

  first_hit_review:
    actions:
      - say:
          text: "<speed=72>챙-!</speed> <speed=38>숫자 단서가 용의 범위를 줄인다.</speed>"
      - say:
          char: 코난.serious
          with:
            - 신이치.cold
          text: "<speed=48>2번으로 고정한다.</speed> <speed=34>이 진술, 확정할까?</speed>"
      - choice:
          key: shinichi_first_commit
          prompt: "1차 판단을 확정할까?"
          options:
            - text: "확정한다"
              goto: success_line
            - text: "한 번 더 확인한다"
              goto: retry_notice

  first_miss_review:
    actions:
      - say:
          char: 코난.think
          with:
            - 신이치.cold
          text: "<speed=28>숫자 흐름이 안 맞아.</speed> <speed=60>이 답으로 밀면 시간만 잃는다.</speed>"
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "<speed=30>오답입니다.</speed> <speed=54>재확인하시죠.</speed>"
      - choice:
          key: shinichi_first_rebuttal
          prompt: "이 오답을 어떻게 처리할까?"
          options:
            - text: "틀렸다. 다시 묻는다"
              goto: retry_notice
            - text: "아직 맞다고 본다"
              add:
                trust: -1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "<speed=26>(좋아, 다시.)</speed> <speed=58>감 말고 숫자로 간다.</speed>"
      - goto: second_input

  second_input:
    actions:
      - input:
          prompt: "재확인: 피해자 컵 번호는? (1~4)"
          correct: "2"
          errors:
            - "마지막 확인이야. 숫자 하나만 떠올려."
            - "힌트는 2."
            - "정답은 2."
          routes:
            - equals: "2"
              set:
                clue_order_note: true
              add:
                deduction_score: 1
                trust: 1
              goto: second_hit_review
            - equals: "1"
              add:
                mistake_count: 1
                trust: -1
              goto: second_miss_review
            - equals: "3"
              add:
                mistake_count: 1
                trust: -1
              goto: second_miss_review
            - equals: "4"
              add:
                mistake_count: 1
                trust: -1
              goto: second_miss_review

  second_hit_review:
    actions:
      - say:
          char: 코난.serious
          with:
            - 신이치.cold
          text: "<speed=56>좋아, 또 2번.</speed> <speed=34>최종 단서로 잠근다.</speed>"
      - choice:
          key: shinichi_second_commit
          prompt: "최종 확정할까?"
          options:
            - text: "확정"
              goto: success_line
            - text: "보류"
              add:
                final_confidence: -1
              goto: fail_line

  second_miss_review:
    actions:
      - say:
          char: 코난.think
          with:
            - 신이치.cold
          text: "<speed=28>또 빗나갔어.</speed> <speed=60>숫자 라인은 더 못 버틴다.</speed>"
      - choice:
          key: shinichi_second_rebuttal
          prompt: "지금 선택은?"
          options:
            - text: "여기서 접는다"
              goto: fail_line
            - text: "끝까지 우긴다"
              add:
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=50>좋아, 잔 순서가 잠겼다.</speed> <speed=34>범위가 확 줄었어.</speed>"
      - goto: outro

  fail_line:
    actions:
      - say:
          char: 코난.think
          text: "<speed=24>(잔 순서가 흐리다...)</speed> <speed=58>결론에서 반격을 맞을 수 있어.</speed>"
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>신이치 라인 종료.</speed> <speed=34>라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
