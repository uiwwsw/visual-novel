script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_input
  - scene: retry_notice
  - scene: second_input
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_shinichi
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 신이치.cold
          with:
            - 코난.think
          text: "동일 질문 반복은 효율이 낮습니다. 다른 축을 확인하시죠."
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: tension
      - set:
          visited_shinichi: true
      - add:
          investigation_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 신이치
          position: right
          emotion: cold
      - say:
          char: 신이치.cold
          with:
            - 코난.serious
          text: "숫자와 순서만 남깁시다. 기억은 그 두 가지로 충분합니다."
      - say:
          char: 코난.serious
          text: "좋아. 잔 배치 기억부터 검증한다."

  first_input:
    actions:
      - input:
          prompt: "신이치가 말한 '피해자 잔 번호'는? (1~4)"
          correct: "2"
          errors:
            - "범위는 1~4. 신이치는 숫자를 또렷이 말했다."
            - "힌트: 신이치는 두 번째 잔을 먼저 언급했어."
            - "정답은 2."
          routes:
            - equals: "2"
              set:
                clue_order_note: true
              add:
                deduction_score: 2
                final_confidence: 1
                trust: 1
              goto: success_line
            - equals: "1"
              add:
                mistake_count: 1
              goto: retry_notice
            - equals: "3"
              add:
                mistake_count: 1
              goto: retry_notice
            - equals: "4"
              add:
                mistake_count: 1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "한 번만 더 확인하자. 감정이 아니라 숫자만 붙잡아."
      - goto: second_input

  second_input:
    actions:
      - input:
          prompt: "재확인: 피해자 잔 번호는? (1~4)"
          correct: "2"
          errors:
            - "마지막 기회야. 신이치 진술의 숫자를 다시 떠올려."
            - "힌트는 그대로 2."
            - "정답은 2."
          routes:
            - equals: "2"
              set:
                clue_order_note: true
              add:
                deduction_score: 1
                trust: 1
              goto: success_line
            - equals: "1"
              add:
                mistake_count: 1
                trust: -1
              goto: fail_line
            - equals: "3"
              add:
                mistake_count: 1
                trust: -1
              goto: fail_line
            - equals: "4"
              add:
                mistake_count: 1
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - say:
          char: 코난.serious
          text: "좋아, 잔 순서 메모가 잠겼다. 누가 순서를 알았는지 범위가 줄었어."
      - goto: outro

  fail_line:
    actions:
      - say:
          char: 코난.think
          text: "아직 잔 순서 축이 느슨해. 다른 대면에서 빈칸을 메워야 해."
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "신이치 대면 종료. 조사 라운지로 복귀한다."
      - goto: /routes/hub/1.yaml
