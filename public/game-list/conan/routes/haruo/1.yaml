script:
  - scene: entry_guard
  - scene: revisit_notice
  - scene: intro
  - scene: first_probe
  - scene: first_claim_correct
  - scene: first_claim_wrong
  - scene: retry_notice
  - scene: second_probe
  - scene: second_claim_correct
  - scene: second_claim_wrong
  - scene: success_line
  - scene: fail_line
  - scene: outro

scenes:
  entry_guard:
    actions:
      - branch:
          cases:
            - when:
                var: visited_haruo
                op: eq
                value: true
              goto: revisit_notice
          default: intro

  revisit_notice:
    actions:
      - bg: tea_room
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "<speed=30>하루오 씨 현장은 이미 봉인 완료.</speed> <speed=58>다른 라인을 먼저 보자.</speed>"
      - goto: /routes/hub/1.yaml

  intro:
    actions:
      - bg: tea_room
      - music: reasoning
      - effect: darken
      - set:
          visited_haruo: true
      - add:
          investigation_count: 1
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 란
          position: left
          emotion: worried
      - sticker:
          id: haruo_lid
          image: clue_lid
          x: 51
          y: 44
          width: 56
          anchorX: center
          anchorY: center
          enter:
            effect: blurIn
      - say:
          char: 코난.serious
          with:
            - 란.worried
          text: '<speed=34>하루오 씨가 남긴 "2R".</speed> <speed=30>그리고 컵 가장자리의 닦인 원형 자국.</speed>'
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "<speed=30>유언일까...</speed> <speed=26>아니면 누가 덧칠한 걸까...</speed>"

  first_probe:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=36>첫 질문이다.</speed> <speed=30>가장 먼저 신뢰할 수 있는 물증은 뭐지?</speed>"
      - choice:
          key: haruo_first_probe
          prompt: "하루오 현장에서 1순위로 고정할 단서는?"
          options:
            - text: "다잉 메시지 주변의 닦인 자국(손수건 섬유 흔적)"
              set:
                clue_haruo_wipe: true
              add:
                deduction_score: 2
                trust: 1
              goto: first_claim_correct
            - text: "글씨체 인상만으로 작성자를 단정"
              add:
                mistake_count: 1
                trust: -1
              goto: first_claim_wrong
            - text: "비명 크기로 범인을 특정"
              add:
                mistake_count: 1
              goto: first_claim_wrong

  first_claim_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=56>좋아, 맞아.</speed> <speed=34>닦인 자국은 위조 개입을 증명하는 핵심이다.</speed>"
      - choice:
          key: haruo_first_commit
          prompt: "이 단서를 채택할까?"
          options:
            - text: "채택"
              goto: success_line
            - text: "한 번 더 확인"
              goto: second_probe

  first_claim_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>인상 비평으론 못 버텨.</speed> <speed=58>물리 흔적부터 잠가야 해.</speed>"
      - choice:
          key: haruo_first_rebuttal
          prompt: "이 판단을 어떻게 처리할까?"
          options:
            - text: "틀렸다. 다시 확인"
              goto: retry_notice
            - text: "아직 이 해석을 민다"
              add:
                trust: -1
              goto: retry_notice

  retry_notice:
    actions:
      - say:
          char: 코난.think
          text: "<speed=26>(다시 간다.)</speed> <speed=58>감상이 아니라 자국과 반응이다.</speed>"
      - goto: second_probe

  second_probe:
    actions:
      - choice:
          key: haruo_second_probe
          prompt: "재선택: 최종 채택할 문장은?"
          options:
            - text: "다잉 메시지 주변 닦임 + 컵 가장자리 반응은 같은 시점이다"
              set:
                clue_haruo_wipe: true
                clue_rim_reagent: true
              add:
                deduction_score: 1
              goto: second_claim_correct
            - text: "메시지 하나만으로 단독 범행을 확정한다"
              add:
                mistake_count: 1
              goto: second_claim_wrong
            - text: "현장 오염이니 전부 폐기한다"
              add:
                mistake_count: 1
                trust: -1
              goto: second_claim_wrong

  second_claim_correct:
    actions:
      - say:
          text: "<speed=70>챙-!</speed> <speed=38>다잉 메시지와 닦임 자국이 같은 타이밍으로 포개진다.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=56>좋아.</speed> <speed=34>하루오 씨 현장 단서는 최종 증거군으로 승격한다.</speed>"
      - choice:
          key: haruo_second_commit
          prompt: "최종 채택할까?"
          options:
            - text: "채택"
              goto: success_line
            - text: "보류"
              add:
                final_confidence: -1
              goto: fail_line

  second_claim_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>그 선택은 양극단이야.</speed> <speed=58>증거 해석이 끊겨 버린다.</speed>"
      - choice:
          key: haruo_second_rebuttal
          prompt: "지금 선택은?"
          options:
            - text: "접고 돌아간다"
              goto: fail_line
            - text: "끝까지 밀어붙인다"
              add:
                trust: -1
              goto: fail_line

  success_line:
    actions:
      - clearSticker:
          id: haruo_lid
          leave:
            effect: fadeOut
      - say:
          char: 코난.serious
          text: "<speed=50>좋아, 하루오 씨 라인 잠금 완료.</speed> <speed=34>위조 흔적이 확정됐다.</speed>"
      - add:
          final_confidence: 1
      - goto: outro

  fail_line:
    actions:
      - clearSticker:
          id: haruo_lid
          leave:
            effect: fadeOut
      - say:
          char: 코난.think
          text: "<speed=24>(현장 해석이 아직 약해...)</speed> <speed=58>결론에서 반드시 보강해야 해.</speed>"
      - add:
          final_confidence: -1
      - goto: outro

  outro:
    actions:
      - say:
          char: 코난
          text: "<speed=50>하루오 라인 종료.</speed> <speed=34>라운지로 복귀한다.</speed>"
      - goto: /routes/hub/1.yaml
