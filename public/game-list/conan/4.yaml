meta:
  title: "명탐정 코난 외전: 다실의 비밀"
  author: "uiwwsw"
  version: "3.0"

settings:
  textSpeed: 38
  autoSave: true
  clickToInstant: true

assets:
  backgrounds:
    mountain_rain: assets/bg/mountain_rain.png
    ryokan_hall: assets/bg/ryokan_hall.png
    tea_room: assets/bg/tea_room.png
    police_tape: assets/bg/police_tape.svg

  characters:
    코난:
      base: assets/char/conan/base.png
      emotions:
        think: assets/char/conan/think.png
        serious: assets/char/conan/serious.png

    란:
      base: assets/char/ran/base.png
      emotions:
        surprised: assets/char/ran/surprised.png
        worried: assets/char/ran/worried.png

    코고로:
      base: assets/char/kogoro/base.png
      emotions:
        proud: assets/char/kogoro/proud.png
        angry: assets/char/kogoro/angry.png

    켄지:
      base: assets/char/kenji/base.png
      emotions:
        angry: assets/char/kenji/angry.png

    레이코:
      base: assets/char/reiko/base.png
      emotions:
        nervous: assets/char/reiko/nervous.png

    신이치:
      base: assets/char/shinichi/base.png
      emotions:
        cold: assets/char/shinichi/cold.png

    하루오:
      base: assets/char/haruo/base.png
      emotions:
        scared: assets/char/haruo/scared.png

  music:
    rain: assets/music/rain.wav
    tension: assets/music/tension.wav
    mystery: assets/music/mystery.wav

  sfx:
    thunder: assets/sfx/thunder.wav
    scream: assets/sfx/scream.wav
    door: assets/sfx/door.wav

state:
  defaults:
    trust: 0
    found_key: false
    suspect: ""
    culprit_answer: ""
    alliance: ""
    timeline_answer: ""
    clue_word: ""

endings:
  true_end:
    title: "TRUE END"
    message: "모든 증언을 연결해 완전한 진실에 도달했다."
  normal_end:
    title: "NORMAL END"
    message: "사건은 해결됐지만, 모든 의문이 사라지진 않았다."
  bad_end:
    title: "BAD END"
    message: "결정적 한 수를 놓쳐 진실이 흐려졌다."

endingRules:
  - when:
      all:
        - var: trust
          op: gte
          value: 4
        - var: found_key
          op: eq
          value: true
        - var: culprit_answer
          op: eq
          value: "신이치"
    ending: true_end
  - when:
      var: trust
      op: gte
      value: 2
    ending: normal_end

defaultEnding: bad_end

script:
  - scene: final_gate
  - scene: false_accuse
  - scene: culprit_reveal
  - scene: handoff_true
  - scene: handoff_normal
  - scene: handoff_chaos
  - scene: epilogue_auto

scenes:
  final_gate:
    actions:
      - bg: tea_room
      - music: mystery
      - say:
          text: "제4장 - 다실의 비밀, 하나의 진실"
      - char:
          id: 코난
          position: center
          emotion: serious
      - input:
          prompt: "문을 밀실로 보이게 만든 핵심 인물을 입력해줘."
          correct: "신이치"
          errors:
            - "현장 동선과 외투 단서를 함께 떠올려봐."
            - "문틈 줄 트릭을 실행할 위치를 생각해봐."
            - "정답은 신이치야."
          saveAs: culprit_answer
          routes:
            - equals: "신이치"
              set:
                suspect: "신이치"
              add:
                trust: 1
              goto: culprit_reveal
            - equals: "레이코"
              set:
                suspect: "레이코"
              add:
                trust: -1
              goto: false_accuse

  false_accuse:
    actions:
      - bg: ryokan_hall
      - music: tension
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          text: "코난의 지목은 빗나갔고, 진술은 다시 안개 속으로 흩어졌다."
      - ending: bad_end

  culprit_reveal:
    actions:
      - bg: ryokan_hall
      - sticker:
          id: tape
          image: police_tape
          x: 0
          y: 30
          width: 120
          anchorX: left
          anchorY: top
          zIndex: 1
          enter:
            effect: fadeIn
            duration: 280
            easing: ease-out
      - music: tension
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 코고로
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "신이치 씨. 당신은 계약 증거가 공개되기 전에 입을 막으려 했어."
      - branch:
          cases:
            - when:
                all:
                  - var: trust
                    op: gte
                    value: 4
                  - var: suspect
                    op: eq
                    value: "신이치"
              goto: handoff_true
            - when:
                var: trust
                op: gte
                value: 2
              goto: handoff_normal
          default: handoff_chaos

  handoff_true:
    actions:
      - effect: flash
      - say:
          char: 신이치.cold
          text: "...그래. 내가 찔렀다. 도망칠 생각은 없다."
      - say:
          char: 코고로.angry
          text: "현행범으로 체포한다!"
      - ending: true_end

  handoff_normal:
    actions:
      - effect: darken
      - say:
          char: 코난
          text: "자백은 확보했지만, 공범 여부는 추가 조사가 필요해."
      - goto: epilogue_auto

  handoff_chaos:
    actions:
      - effect: shake
      - say:
          text: "핵심 진술이 갈라지며 현장은 다시 혼란에 빠졌다."
      - ending: bad_end

  epilogue_auto:
    actions:
      - bg: mountain_rain
      - music: rain
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          text: "새벽이 되자 비는 가늘어졌다."
      - say:
          text: "계약서보다 무거운 건, 서로를 믿지 못한 시간이었다."
      - wait: 500
      - effect: blur
      - say:
          text: "<speed=20>CASE CLOSED</speed>"
