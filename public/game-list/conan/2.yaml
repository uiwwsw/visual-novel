script:
  - scene: first_scan
  - scene: residue_focus
  - scene: residue_claim_correct
  - scene: residue_claim_wrong
  - scene: timeline_gate
  - scene: reconstruction_choice
  - scene: reconstruction_claim_correct
  - scene: reconstruction_claim_wrong
  - scene: deduction_branch
  - scene: stable_frame
  - scene: shaky_frame
  - scene: lounge_handoff

scenes:
  first_scan:
    actions:
      - bg: tea_room
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 란
          position: left
          emotion: worried
      - say:
          char: 코난.serious
          with:
            - 란.worried
          text: "아무도 손대지 마. 먼저 잔 표면과 시간 기록부터 눈으로 고정한다."

  residue_focus:
    actions:
      - effect: zoom
      - sticker:
          id: rim_focus
          image: clue_cup
          x: 50
          y: 40
          width: 62
          anchorX: center
          anchorY: center
          enter:
            effect: blurIn
            duration: 380
      - say:
          char: 코난.think
          text: "(첫 단추를 잘못 끼우면 끝까지 틀어진다... 어디부터 잡을지 정해.)"
      - choice:
          key: residue_focus_choice
          prompt: "잔에서 먼저 봐야 할 건 뭐지?"
          options:
            - text: "가장자리 반응부터 확인한다"
              set:
                clue_rim_reagent: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: residue_claim_correct
            - text: "찻상 바닥 흠집부터 확인한다"
              add:
                mistake_count: 1
                trust: -1
              goto: residue_claim_wrong
            - text: "향만 맡고 넘어간다"
              add:
                mistake_count: 1
              goto: residue_claim_wrong

  residue_claim_correct:
    actions:
      - say:
          char: 코난.serious
          text: "좋아, 정답이야. 가장자리 반응부터 잡는 게 정석이다. 이 판단을 확정할까?"
      - choice:
          key: residue_commit_choice
          prompt: "1차 판단을 확정할까?"
          options:
            - text: "확정하고 다음으로 간다"
              goto: timeline_gate
            - text: "아직 불안하다. 보류하고 넘어간다"
              add:
                final_confidence: -1
              goto: timeline_gate

  residue_claim_wrong:
    actions:
      - say:
          char: 코난.think
          text: "우선순위가 틀렸어. 하지만 아직 늦지 않았다. 이 판단, 오답으로 정리할래?"
      - choice:
          key: residue_rebuttal_choice
          prompt: "방금 선택을 어떻게 처리할까?"
          options:
            - text: "틀렸다. 다음 질문으로 넘어간다"
              goto: timeline_gate
            - text: "아냐, 이걸로도 밀어본다"
              add:
                trust: -1
              goto: timeline_gate

  timeline_gate:
    actions:
      - clearSticker:
          id: rim_focus
          leave:
            effect: fadeOut
            duration: 220
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "다음은 시간선이다. 비명이 터진 시각을 정확히 찍어 봐."
      - input:
          prompt: "비명이 들린 시각을 24시간 형식으로 입력해줘."
          correct: "21:30"
          saveAs: timeline_answer
          errors:
            - "시계를 떠올려. 긴 바늘이 어디를 가리켰지?"
            - "힌트: 밤 9시 30분."
            - "정답은 21:30."
          routes:
            - equals: "21:30"
              add:
                deduction_score: 2
                trust: 1
              goto: reconstruction_choice
            - equals: "21:20"
              add:
                mistake_count: 1
                trust: -1
              goto: reconstruction_choice
            - equals: "22:00"
              add:
                mistake_count: 1
              goto: reconstruction_choice

  reconstruction_choice:
    actions:
      - bg: case_board
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: "좋아, 재현으로 간다. '뚜껑 두 번'의 의미를 논리로 잠가."
      - choice:
          key: reconstruction_choice
          prompt: "주전자 뚜껑을 두 번 누른 건 무슨 뜻일까?"
          options:
            - text: "그 동작 자체가 독 투입이었다"
              add:
                mistake_count: 1
              goto: reconstruction_claim_wrong
            - text: "시선을 돌리려는 눈속임이었다"
              set:
                clue_double_press_decoy: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: reconstruction_claim_correct
            - text: "원래 습관이라 의미가 없다"
              add:
                mistake_count: 1
                trust: -1
              goto: reconstruction_claim_wrong

  reconstruction_claim_correct:
    actions:
      - say:
          char: 코난.serious
          text: "좋아, 눈속임 해석이 맞다. 이걸로 사건 흐름을 못 박을까?"
      - choice:
          key: reconstruction_commit_choice
          prompt: "재현 해석을 최종 채택할까?"
          options:
            - text: "채택한다"
              goto: deduction_branch
            - text: "보류한다"
              add:
                final_confidence: -1
              goto: deduction_branch

  reconstruction_claim_wrong:
    actions:
      - say:
          char: 코난.think
          text: "그 해석으론 동선이 이어지지 않아. 대면 조사에서 반드시 보강해야 한다."
      - choice:
          key: reconstruction_rebuttal_choice
          prompt: "방금 해석을 어떻게 처리할까?"
          options:
            - text: "틀렸다 인정하고 진행한다"
              goto: deduction_branch
            - text: "끝까지 이 해석으로 민다"
              add:
                trust: -1
              goto: deduction_branch

  deduction_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: deduction_score
                    op: gte
                    value: 4
                  - var: trust
                    op: gte
                    value: 0
                  - var: clue_double_press_decoy
                    op: eq
                    value: true
              goto: stable_frame
          default: shaky_frame

  stable_frame:
    actions:
      - effect: zoom
      - say:
          text: "챙-! 흩어진 단서들이 하나의 선으로 이어졌다."
      - say:
          char: 코난.serious
          text: "좋아, 흐름이 잡혔어. 이제 용의자 하나씩 대면해서 빈칸만 메우면 돼."
      - add:
          final_confidence: 1
      - goto: lounge_handoff

  shaky_frame:
    actions:
      - effect: pulse
      - say:
          char: 코난.think
          text: "(실마리는 잡혔지만 아직 느슨해... 대면에서 더 끌어내야 한다.)"
      - add:
          mistake_count: 1
      - goto: lounge_handoff

  lounge_handoff:
    actions:
      - bg: case_board
      - say:
          char: 코난
          text: "조사 라운지로 이동한다. 범인은 이 안에 있어, 한 명씩 확인하자."
      - goto: /routes/hub/1.yaml
