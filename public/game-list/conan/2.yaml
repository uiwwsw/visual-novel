script:
  - scene: probe_intro
  - scene: clue_kettle_lid
  - scene: timeline_input_gate
  - scene: witness_order_gate
  - scene: room_simulation
  - scene: pressure_split
  - scene: precision_probe
  - scene: shaky_probe
  - scene: route_branch
  - scene: kenji_detour

scenes:
  probe_intro:
    actions:
      - bg: tea_room
      - music: mystery
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 란
          position: left
          emotion: worried
      - say:
          char: 코난.serious
          with:
            - 란.worried
          text: "수사는 두 갈래야. 시간축, 그리고 차를 따르는 손의 습관."
      - say:
          char: 란.worried
          with:
            - 코난.serious
          text: "다 같은 차였는데 왜 주인님 잔에서만 독이 나온 거지...?"

  clue_kettle_lid:
    actions:
      - bg: tea_room
      - effect: zoom
      - sticker:
          id: lid_focus
          image: police_tape
          x: 50
          y: 34
          width: 62
          anchorX: center
          anchorY: center
          enter:
            effect: blurIn
            duration: 380
      - say:
          char: 코난.think
          text: "뚜껑 안쪽의 미세한 가루... 잔이 아니라, 주전자 자체가 장치였어."
      - set:
          kettle_trick_known: true
      - add:
          truth_point: 1
      - clearSticker:
          id: lid_focus
          leave:
            effect: fadeOut
            duration: 220

  timeline_input_gate:
    actions:
      - music: tension
      - char:
          id: 코난
          position: center
          emotion: think
      - input:
          prompt: "비명이 들린 시각(24시간 형식)을 입력해줘."
          correct: "21:30"
          saveAs: timeline_answer
          errors:
            - "벽시계 분침 위치를 다시 떠올려봐."
            - "힌트: 9시 30분."
            - "정답은 21:30."
          routes:
            - equals: "21:30"
              set:
                locked_room_confirmed: true
              add:
                truth_point: 2
                trust: 1
              goto: witness_order_gate
            - equals: "21:20"
              add:
                mistake_count: 1
                trust: -1
              goto: witness_order_gate
            - equals: "22:00"
              add:
                mistake_count: 1
              goto: witness_order_gate

  witness_order_gate:
    actions:
      - bg: ryokan_hall
      - char:
          id: 신이치
          position: right
          emotion: cold
      - char:
          id: 레이코
          position: left
          emotion: nervous
      - choice:
          key: witness_order
          prompt: "누구의 증언부터 고정할까?"
          options:
            - text: "레이코의 금속 냄새 증언을 먼저 잡는다"
              set:
                metal_smell_flag: true
                witness_priority: "reiko"
              add:
                truth_point: 1
                trust: 1
            - text: "신이치의 잔 배치 기억부터 검증한다"
              set:
                suspect: "신이치"
                witness_priority: "shinichi"
              add:
                truth_point: 1
            - text: "켄지의 분노 동기부터 파고든다"
              set:
                suspect: "켄지"
                witness_priority: "kenji"
              add:
                mistake_count: 1
                trust: -1

  room_simulation:
    actions:
      - bg: tea_room
      - effect: tilt
      - say:
          char: 코난
          text: "이 각도에서 따르면 뚜껑 안쪽 성분이 한 번에 떨어진다."
      - wait: 360
      - choice:
          key: room_reconstruction
          prompt: "현장 재현 결론을 어떻게 기록할까?"
          options:
            - text: "피해자 잔 순서가 사전에 노출됐다고 기록한다"
              set:
                room_reconstruction_ok: true
              add:
                truth_point: 1
            - text: "밀실이니까 우연이라고 적는다"
              set:
                room_reconstruction_ok: false
              add:
                mistake_count: 1

  pressure_split:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: truth_point
                    op: gte
                    value: 4
                  - var: trust
                    op: gte
                    value: 1
                  - var: room_reconstruction_ok
                    op: eq
                    value: true
              goto: precision_probe
          default: shaky_probe

  precision_probe:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "좋아. 이 페이스면 범인이 방어할 틈이 없어."
      - add:
          final_confidence: 1
      - goto: route_branch

  shaky_probe:
    actions:
      - effect: pulse
      - say:
          char: 코난.think
          text: "아직 연결이 약해. 한 번만 더 실수하면 흐름이 꺾여."
      - add:
          mistake_count: 1
      - goto: route_branch

  route_branch:
    actions:
      - branch:
          cases:
            - when:
                var: suspect
                op: eq
                value: "신이치"
              goto: ./routes/shinichi/1.yaml
            - when:
                var: suspect
                op: eq
                value: "켄지"
              goto: kenji_detour
          default: ./routes/reiko/1.yaml

  kenji_detour:
    actions:
      - bg: tea_room
      - char:
          id: 켄지
          position: left
          emotion: angry
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 켄지.angry
          with:
            - 코난.think
          text: "난 화는 났어도 차 순서 같은 건 몰라. 그런 거 할 머리도 없어."
      - choice:
          key: kenji_detour_choice
          prompt: "켄지 분기에서 다음 판단은?"
          options:
            - text: "켄지를 배제하고 신이치 동선으로 전환한다"
              set:
                suspect: "신이치"
              add:
                truth_point: 1
                trust: 1
              goto: ./routes/shinichi/1.yaml
            - text: "켄지 의심을 유지한 채 간접 검증으로 우회한다"
              set:
                suspect: "레이코"
              add:
                mistake_count: 1
              goto: ./routes/reiko/1.yaml
