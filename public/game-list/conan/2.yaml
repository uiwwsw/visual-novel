script:
  - scene: first_scan
  - scene: residue_focus
  - scene: residue_claim_correct
  - scene: residue_claim_wrong
  - scene: timeline_gate
  - scene: reconstruction_choice
  - scene: reconstruction_claim_correct
  - scene: reconstruction_claim_wrong
  - scene: deduction_branch
  - scene: stable_frame
  - scene: shaky_frame
  - scene: lounge_handoff

scenes:
  first_scan:
    actions:
      - bg: tea_room
      - music: reasoning
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 란
          position: left
          emotion: worried
      - say:
          char: 코난.serious
          text: "<speed=40>좋아, 정리한다.</speed> <speed=30>피해자는 하루오 씨.</speed> <speed=62>살인 방식은 컵 주변 반응이다.</speed>"
      - say:
          char: 란.worried
          text: '<speed=34>다잉 메시지 "2R"도 있었지...</speed> <speed=26>그것도 진짜일까?</speed>'

  residue_focus:
    actions:
      - effect: zoom
      - sticker:
          id: rim_focus
          image: clue_cup
          x: 50
          y: 40
          width: 62
          anchorX: center
          anchorY: center
          enter:
            effect: blurIn
            duration: 380
      - say:
          char: 코난.think
          text: "<speed=24>(첫 단서를 틀리면 끝까지 흔들린다.)</speed> <speed=58>뭘 먼저 잡지?</speed>"
      - choice:
          key: residue_focus_choice
          prompt: "현장에서 가장 먼저 고정해야 할 포인트는?"
          options:
            - text: "찻잔 가장자리 반응을 우선 확인한다"
              set:
                clue_rim_reagent: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: residue_claim_correct
            - text: "다잉 메시지 글씨체만 먼저 분석한다"
              add:
                mistake_count: 1
                trust: -1
              goto: residue_claim_wrong
            - text: "주전자 뚜껑만 보고 결론을 낸다"
              add:
                mistake_count: 1
              goto: residue_claim_wrong

  residue_claim_correct:
    actions:
      - say:
          char: 코난.serious
          text: "<speed=52>정답.</speed> <speed=34>반응 순서부터 고정해야 메시지 위조 여부도 판별할 수 있어.</speed>"
      - choice:
          key: residue_commit_choice
          prompt: "1차 판단을 확정할까?"
          options:
            - text: "확정하고 진행"
              goto: timeline_gate
            - text: "조금 더 보류"
              add:
                final_confidence: -1
              goto: timeline_gate

  residue_claim_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>우선순위가 틀렸어.</speed> <speed=62>글씨보다 먼저, 독 반응 시점을 잡아야 해.</speed>"
      - choice:
          key: residue_rebuttal_choice
          prompt: "방금 선택을 어떻게 처리할까?"
          options:
            - text: "틀렸다 인정하고 진행"
              goto: timeline_gate
            - text: "아직 이 해석을 민다"
              add:
                trust: -1
              goto: timeline_gate

  timeline_gate:
    actions:
      - clearSticker:
          id: rim_focus
          leave:
            effect: fadeOut
            duration: 220
      - get: tea_residue_report
      - set:
          item_tea_residue_report_owned: true
      - sticker:
          id: item_popup_tea_residue_report
          image: item_tea_residue_report
          x: 50
          y: 30
          width: 22
          enter:
            effect: popIn
            duration: 280
          inputLockMs: 500
      - char:
          id: 코난
          position: center
          emotion: think
      - say:
          char: 코난.think
          text: "<speed=34>찻잔 반응 시료 카드를 획득했다.</speed> <speed=58>이제 시간선을 잠근다.</speed>"
      - clearSticker:
          id: item_popup_tea_residue_report
          leave:
            effect: fadeOut
            duration: 1800
      - say:
          char: 코난.think
          text: "<speed=30>다음은 시간선.</speed> <speed=24>비명이 터진 정확한 시각을 입력해.</speed>"
      - input:
          prompt: "비명이 들린 시각은? (24시간 형식)"
          correct: "21:30"
          saveAs: timeline_answer
          errors:
            - "시계 바늘을 떠올려. 긴 바늘은 6을 가리켰어."
            - "힌트: 밤 9시 30분."
            - "정답은 21:30."
          routes:
            - equals: "21:30"
              add:
                deduction_score: 2
                trust: 1
              goto: reconstruction_choice
            - equals: "21:20"
              add:
                mistake_count: 1
                trust: -1
              goto: reconstruction_choice
            - equals: "22:00"
              add:
                mistake_count: 1
              goto: reconstruction_choice

  reconstruction_choice:
    actions:
      - bg: case_board
      - char:
          id: 코난
          position: center
          emotion: serious
      - say:
          char: 코난.serious
          text: '<speed=34>재구성으로 간다.</speed> <speed=66>"뚜껑 두 번"은 무슨 의미였지?</speed>'
      - choice:
          key: reconstruction_choice
          prompt: "주전자 뚜껑을 두 번 누른 동작의 의미는?"
          options:
            - text: "그 동작 자체가 독 투입이었다"
              add:
                mistake_count: 1
              goto: reconstruction_claim_wrong
            - text: "시선을 다잉 메시지 쪽으로 돌리려는 연막이었다"
              set:
                clue_double_press_decoy: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: reconstruction_claim_correct
            - text: "의미 없는 습관 동작이었다"
              add:
                mistake_count: 1
                trust: -1
              goto: reconstruction_claim_wrong

  reconstruction_claim_correct:
    actions:
      - say:
          char: 코난.serious
          text: '<speed=56>좋아, 연막 해석이 맞다.</speed> <speed=34>이제 "2R"의 진짜 주인을 찾을 수 있어.</speed>'
      - choice:
          key: reconstruction_commit_choice
          prompt: "이 해석을 최종 채택할까?"
          options:
            - text: "채택"
              goto: deduction_branch
            - text: "보류"
              add:
                final_confidence: -1
              goto: deduction_branch

  reconstruction_claim_wrong:
    actions:
      - say:
          char: 코난.think
          text: "<speed=28>그 해석으론 동선이 끊긴다.</speed> <speed=62>용의자 대면에서 반박당해.</speed>"
      - choice:
          key: reconstruction_rebuttal_choice
          prompt: "방금 해석을 어떻게 처리할까?"
          options:
            - text: "틀렸다 인정하고 진행"
              goto: deduction_branch
            - text: "끝까지 이 해석으로 간다"
              add:
                trust: -1
              goto: deduction_branch

  deduction_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: deduction_score
                    op: gte
                    value: 4
                  - var: trust
                    op: gte
                    value: 0
                  - var: clue_double_press_decoy
                    op: eq
                    value: true
              goto: stable_frame
          default: shaky_frame

  stable_frame:
    actions:
      - effect: zoom
      - say:
          text: "<speed=70>챙-!</speed> <speed=42>흩어진 조각이 하나의 선으로 잠겼다.</speed>"
      - say:
          char: 코난.serious
          text: "<speed=50>좋아.</speed> <speed=34>이제 네 명 라인을 하나씩 대면하면 범인은 도망 못 간다.</speed>"
      - add:
          final_confidence: 1
      - goto: lounge_handoff

  shaky_frame:
    actions:
      - effect: tilt
      - say:
          char: 코난.think
          text: "<speed=24>(실마리는 잡혔지만 느슨해...)</speed> <speed=58>대면에서 빈칸을 메워야 해.</speed>"
      - add:
          mistake_count: 1
      - goto: lounge_handoff

  lounge_handoff:
    actions:
      - bg: case_board
      - say:
          char: 코난
          text: "<speed=48>조사 라운지로 이동한다.</speed> <speed=34>다음은 사람을 읽을 차례야.</speed>"
      - goto: /routes/hub/1.yaml
