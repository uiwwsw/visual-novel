script:
  - scene: first_scan
  - scene: residue_focus
  - scene: timeline_gate
  - scene: reconstruction_choice
  - scene: deduction_branch
  - scene: stable_frame
  - scene: shaky_frame
  - scene: lounge_handoff

scenes:
  first_scan:
    actions:
      - bg: tea_room
      - music: mystery
      - char:
          id: 코난
          position: center
          emotion: serious
      - char:
          id: 란
          position: left
          emotion: worried
      - say:
          char: 코난.serious
          with:
            - 란.worried
          text: "현장을 건드리지 않고 본다. 잔 표면과 시간 기록을 먼저 고정하자."

  residue_focus:
    actions:
      - effect: zoom
      - sticker:
          id: rim_focus
          image: clue_cup
          x: 50
          y: 40
          width: 62
          anchorX: center
          anchorY: center
          enter:
            effect: blurIn
            duration: 380
      - choice:
          key: residue_focus_choice
          prompt: "잔 표면에서 먼저 확인할 항목은?"
          options:
            - text: "가장자리 미세 결정 반응을 확인한다"
              set:
                clue_rim_reagent: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: timeline_gate
            - text: "찻상 바닥의 흠집부터 본다"
              add:
                mistake_count: 1
                trust: -1
              goto: timeline_gate
            - text: "향만 확인하고 넘어간다"
              add:
                mistake_count: 1
              goto: timeline_gate

  timeline_gate:
    actions:
      - clearSticker:
          id: rim_focus
          leave:
            effect: fadeOut
            duration: 220
      - music: tension
      - char:
          id: 코난
          position: center
          emotion: think
      - input:
          prompt: "비명이 들린 시각(24시간 형식)을 입력해줘."
          correct: "21:30"
          saveAs: timeline_answer
          errors:
            - "벽시계의 긴 바늘 위치를 다시 떠올려봐."
            - "힌트: 9시 30분이었어."
            - "정답은 21:30."
          routes:
            - equals: "21:30"
              add:
                deduction_score: 2
                trust: 1
              goto: reconstruction_choice
            - equals: "21:20"
              add:
                mistake_count: 1
                trust: -1
              goto: reconstruction_choice
            - equals: "22:00"
              add:
                mistake_count: 1
              goto: reconstruction_choice

  reconstruction_choice:
    actions:
      - bg: case_board
      - char:
          id: 코난
          position: center
          emotion: serious
      - choice:
          key: reconstruction_choice
          prompt: "뚜껑을 두 번 누른 동작은 무엇을 의미할까?"
          options:
            - text: "독 투입 그 자체를 가리킨다"
              add:
                mistake_count: 1
              goto: deduction_branch
            - text: "시선을 분산시키기 위한 미끼 동작이다"
              set:
                clue_double_press_decoy: true
              add:
                deduction_score: 2
                final_confidence: 1
              goto: deduction_branch
            - text: "습관이라서 의미가 없다"
              add:
                mistake_count: 1
                trust: -1
              goto: deduction_branch

  deduction_branch:
    actions:
      - branch:
          cases:
            - when:
                all:
                  - var: deduction_score
                    op: gte
                    value: 4
                  - var: trust
                    op: gte
                    value: 0
                  - var: clue_double_press_decoy
                    op: eq
                    value: true
              goto: stable_frame
          default: shaky_frame

  stable_frame:
    actions:
      - effect: zoom
      - say:
          char: 코난.serious
          text: "좋아, 프레임이 잡혔어. 이제 사람별 대면으로 빈칸을 메운다."
      - add:
          final_confidence: 1
      - goto: lounge_handoff

  shaky_frame:
    actions:
      - effect: pulse
      - say:
          char: 코난.think
          text: "연결은 보이지만 고리가 느슨해. 대면에서 단서를 더 모아야 해."
      - add:
          mistake_count: 1
      - goto: lounge_handoff

  lounge_handoff:
    actions:
      - bg: case_board
      - say:
          char: 코난
          text: "조사 라운지로 간다. 네 사람을 순서대로 만나고 결론을 닫자."
      - goto: /routes/hub/1.yaml
